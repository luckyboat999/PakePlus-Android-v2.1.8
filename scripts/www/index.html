<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字排盘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* 主色调 */
            --primary-color: #1976d2;
            --primary-hover: #1565c0;
            
            /* 辅助色 */
            --background-color: #f5f5f5;
            --surface-color: #ffffff;
            --border-color: #e0e0e0;
            
            /* 强调色 */
            --error-color: #f44336;
            --error-hover: #d32f2f;
            --success-color: #4caf50;
            --success-hover: #388e3c;
            
            /* 文本颜色 */
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-hint: #999999;
            
            /* 阴影 */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.1);
            
            /* 圆角 */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-full: 50%;
            
            /* 过渡动画 */
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 24px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 32px;
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: 1px;
        }
        
        .zhuzhu-labels {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .zhuzhu-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 8px;
            text-align: center;
        }
        
        .tiangan-buttons,
        .dizhi-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .circle-button {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius-full);
            background-color: var(--surface-color);
            border: 2px solid var(--border-color);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        
        .circle-button:hover {
            background-color: rgba(25, 118, 210, 0.05);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .circle-button.active {
            background-color: rgba(25, 118, 210, 0.1);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }
        
        .range-info {
            text-align: center;
            margin-bottom: 24px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .confirm-button {
            display: block;
            width: 180px;
            height: 48px;
            margin: 0 auto;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        
        .confirm-button:hover {
            background-color: var(--primary-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        /* 按钮类型 */
        .primary-button {
            background-color: var(--primary-color);
            color: white;
        }
        
        .primary-button:hover {
            background-color: var(--primary-hover);
        }
        
        .secondary-button {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .secondary-button:hover {
            background-color: #d0d0d0;
        }
        
        .error-button {
            background-color: var(--error-color);
            color: white;
        }
        
        .error-button:hover {
            background-color: var(--error-hover);
        }
        
        .success-button {
            background-color: var(--success-color);
            color: white;
        }
        
        .success-button:hover {
            background-color: var(--success-hover);
        }
        
        .flex {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        /* 结果展示 */
        .result {
            margin-top: 24px;
            padding: 20px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            display: block;
            box-shadow: var(--shadow-sm);
        }
        
        .result h2 {
            text-align: center;
            margin-bottom: 24px;
            color: var(--text-primary);
            font-size: 22px;
            font-weight: 600;
            line-height: 1.2;
        }
        
        /* 排盘结果表格 */
        .bazi-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 32px;
            box-shadow: var(--shadow-sm);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            background-color: var(--surface-color);
            transition: var(--transition);
        }
        
        .bazi-table:hover {
            box-shadow: var(--shadow-md);
        }
        
        .bazi-table th,
        .bazi-table td {
            padding: 16px 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            font-size: 15px;
            line-height: 1.4;
            transition: var(--transition);
        }
        
        .bazi-table th {
            background-color: var(--primary-color);
            font-weight: 600;
            color: white;
            border-bottom: 2px solid var(--primary-hover);
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        .bazi-table tr:hover {
            background-color: rgba(25, 118, 210, 0.05);
            transform: translateY(-1px);
        }
        
        .bazi-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .bazi-table tr:nth-child(even):hover {
            background-color: rgba(25, 118, 210, 0.05);
        }
        
        /* 太公奇门式盘样式 */
        .qimen-panel {
            margin-top: 24px;
            padding: 20px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .qimen-panel h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            line-height: 1.2;
        }
        
        /* 太公奇门排盘滚动容器 */
        .qimen-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 0 -20px;
            padding: 0 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
        }
        
        .qimen-scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .qimen-scroll-container::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: var(--border-radius-full);
        }
        
        .qimen-scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: var(--border-radius-full);
        }
        
        .qimen-scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-hover);
        }
        
        /* 滚动提示 */
        .scroll-indicator {
            text-align: center;
            font-size: 12px;
            color: var(--text-hint);
            margin-top: 8px;
            margin-bottom: 16px;
        }
        
        /* 太公奇门式盘表格样式 */
        .qimen-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            background-color: var(--surface-color);
            transition: var(--transition);
        }
        
        .qimen-table:hover {
            box-shadow: var(--shadow-md);
        }
        
        .qimen-table th,
        .qimen-table td {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            font-size: 14px;
            line-height: 1.4;
            transition: var(--transition);
        }
        
        .qimen-table th {
            background-color: var(--primary-color);
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .qimen-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .qimen-table tr:hover {
            background-color: rgba(25, 118, 210, 0.05);
            transform: translateY(-1px);
        }
        
        .qimen-table tr:nth-child(even):hover {
            background-color: rgba(25, 118, 210, 0.05);
        }
        
        .qimen-panel {
            margin: 16px 0;
        }
        
        .qimen-panel h3 {
            margin-bottom: 10px;
        }
        
        .qimen-info {
            margin: 10px 0;
            padding: 12px;
            background-color: rgba(25, 118, 210, 0.05);
            border-left: 3px solid var(--primary-color);
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }
        
        .qimen-info p {
            margin: 5px 0;
            color: var(--text-secondary);
        }
        
        /* 五行颜色 */
        .wuxing-wood {
            color: #228B22;
            font-weight: 600;
        }
        
        .wuxing-fire {
            color: #FF4500;
            font-weight: 600;
        }
        
        .wuxing-earth {
            color: #FFA500;
            font-weight: 600;
        }
        
        .wuxing-metal {
            color: #FFD700;
            font-weight: 600;
        }
        
        .wuxing-water {
            color: #4169E1;
            font-weight: 600;
        }
        
        /* 十神名称样式 */
        .shishen-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* 日干样式 */
        .riangan {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* 遮罩层 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(2px);
        }
        
        /* 弹窗样式 */
        .tiangan-popup,
        .dizhi-popup,
        .save-case-popup,
        .case-library-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow-lg);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .tiangan-popup,
        .dizhi-popup {
            width: 90%;
            max-width: 500px;
        }
        
        .save-case-popup {
            width: 90%;
            max-width: 500px;
        }
        
        .case-library-popup {
            width: 90%;
            max-width: 800px;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 18px;
            line-height: 1.2;
        }
        
        .none-btn {
            font-size: 14px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            margin-right: 10px;
            transition: var(--transition);
        }
        
        .none-btn:hover {
            background-color: rgba(25, 118, 210, 0.05);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-hint);
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-full);
        }
        
        .close-btn:hover {
            color: var(--text-primary);
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* 天干网格 */
        .tiangan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .tiangan-item {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }
        
        .tiangan-item:hover {
            background-color: rgba(25, 118, 210, 0.05);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .tiangan-item.active {
            background-color: rgba(25, 118, 210, 0.1);
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        /* 地支网格 */
        .dizhi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 10px;
        }
        
        .dizhi-item {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }
        
        .dizhi-item:hover {
            background-color: rgba(25, 118, 210, 0.05);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .dizhi-item.active {
            background-color: rgba(25, 118, 210, 0.1);
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        .dizhi-item.disabled,
        .tiangan-item.disabled {
            background-color: rgba(0, 0, 0, 0.02);
            color: var(--text-hint);
            cursor: not-allowed;
            border-color: var(--border-color);
        }
        
        /* 重置按钮样式 */
        .reset-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 12px;
            background-color: var(--error-color);
            color: white;
            border-radius: var(--border-radius-full);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        .reset-btn:hover {
            background-color: var(--error-hover);
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }
        
        /* 媒体查询 - 移动端适配 */
        @media (max-width: 768px) {
            .container {
                margin: 16px;
                padding: 16px;
            }
            
            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            .zhuzhu-labels {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .zhuzhu-label {
                font-size: 12px;
                margin: 0 4px;
            }
            
            .tiangan-buttons,
            .dizhi-buttons {
                gap: 8px;
            }
            
            .circle-button {
                width: 60px;
                height: 60px;
                font-size: 14px;
            }
            
            .confirm-button {
                width: 150px;
                height: 44px;
                font-size: 14px;
            }
            
            .flex {
                flex-direction: column;
                gap: 12px;
            }
            
            .result {
                margin-top: 20px;
                padding: 16px;
            }
            
            .result h2 {
                font-size: 18px;
                margin-bottom: 16px;
            }
            
            .bazi-table th,
            .bazi-table td {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .qimen-panel {
                padding: 16px;
            }
            
            .qimen-panel h3 {
                font-size: 16px;
            }
            
            .tiangan-popup,
            .dizhi-popup,
            .save-case-popup,
            .case-library-popup {
                padding: 20px;
                width: 95%;
            }
            
            .tiangan-grid,
            .dizhi-grid {
                gap: 8px;
            }
            
            .tiangan-item,
            .dizhi-item {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .popup-header h3 {
                font-size: 16px;
            }
            
            .none-btn {
                padding: 4px 12px;
                font-size: 13px;
            }
        }
        
        /* 案例库弹窗样式 */
        .case-library-popup,
        .save-case-popup,
        .tiangan-popup,
        .dizhi-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .case-library-popup {
            width: 90%;
            max-width: 800px;
        }
        
        .save-case-popup,
        .tiangan-popup,
        .dizhi-popup {
            width: 90%;
            max-width: 400px;
        }
        
        @media (max-width: 768px) {
            .case-library-popup,
            .save-case-popup,
            .tiangan-popup,
            .dizhi-popup {
                padding: 20px;
                width: 95%;
                max-width: 95vw;
            }
        }
        
        @media (max-width: 480px) {
            .case-library-popup,
            .save-case-popup,
            .tiangan-popup,
            .dizhi-popup {
                padding: 16px;
                width: 98%;
                max-width: 98vw;
            }
        }
        
        /* 案例搜索样式 */
        .case-search {
            margin-bottom: 24px;
        }
        
        .case-search h4,
        .case-list h4 {
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
        }
        
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .search-container input {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }
        
        .search-container button {
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .search-hint {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-hint);
            line-height: 1.4;
        }
        
        /* 案例列表样式 */
        .case-list {
            margin-top: 24px;
        }
        
        #case-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* 保存案例表单样式 */
        .save-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-group input,
        .form-group textarea {
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            transition: var(--transition);
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.5;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        @media (max-width: 480px) {
            .save-form {
                gap: 12px;
            }
            
            .form-group input,
            .form-group textarea {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .form-group textarea {
                min-height: 80px;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .form-actions button {
                padding: 10px 16px;
                font-size: 13px;
                width: 100%;
                text-align: center;
            }
        }
        
        /* 案例项样式 */
        .case-item {
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background-color: var(--surface-color);
        }
        
        .case-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        .case-item-content {
            flex: 1;
        }
        
        .case-item h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }
        
        .case-item-time {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: var(--text-hint);
        }
        
        .case-item-note {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .case-item-bazi {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .case-item-delete {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 16px;
                padding: 16px;
            }
            
            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            .zhuzhu-labels {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }
            
            .zhuzhu-label {
                font-size: 12px;
                margin: 0 4px;
                padding: 4px 8px;
                background-color: rgba(25, 118, 210, 0.05);
                border-radius: var(--border-radius-sm);
            }
            
            .tiangan-buttons,
            .dizhi-buttons {
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .circle-button {
                width: 55px;
                height: 55px;
                font-size: 13px;
            }
            
            .confirm-button {
                width: 140px;
                height: 42px;
                font-size: 14px;
            }
            
            .flex {
                flex-direction: column;
                gap: 12px;
            }
            
            .result {
                margin-top: 20px;
                padding: 16px;
            }
            
            .result h2 {
                font-size: 18px;
                margin-bottom: 16px;
            }
            
            .bazi-table th,
            .bazi-table td {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .qimen-panel {
                padding: 16px;
            }
            
            .qimen-panel h3 {
                font-size: 16px;
            }
            
            .tiangan-popup,
            .dizhi-popup,
            .save-case-popup,
            .case-library-popup {
                padding: 20px;
                width: 95%;
            }
            
            .tiangan-grid,
            .dizhi-grid {
                gap: 8px;
            }
            
            .tiangan-item,
            .dizhi-item {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .popup-header h3 {
                font-size: 16px;
            }
            
            .none-btn {
                padding: 4px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 12px;
                padding: 12px;
            }
            
            h1 {
                font-size: 18px;
                margin-bottom: 16px;
            }
            
            .zhuzhu-labels {
                gap: 6px;
            }
            
            .zhuzhu-label {
                font-size: 11px;
                margin: 0 4px;
                padding: 3px 6px;
            }
            
            .tiangan-buttons,
            .dizhi-buttons {
                gap: 6px;
            }
            
            .circle-button {
                width: 48px;
                height: 48px;
                font-size: 12px;
            }
            
            .reset-btn {
                width: 16px;
                height: 16px;
                font-size: 10px;
                top: 2px;
                right: 2px;
            }
            
            .confirm-button {
                width: 120px;
                height: 38px;
                font-size: 13px;
            }
            
            .flex {
                gap: 10px;
            }
            
            .range-info {
                font-size: 12px;
                margin-bottom: 16px;
            }
            
            .bazi-table th,
            .bazi-table td {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .tiangan-item,
            .dizhi-item {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .popup-header {
                margin-bottom: 16px;
            }
            
            .popup-header h3 {
                font-size: 15px;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-container input {
                min-width: unset;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>八字排盘</h1>
        
        <div class="zhuzhu-labels">
            <div class="zhuzhu-label" data-zhuzhu="year">年柱</div>
            <div class="zhuzhu-label" data-zhuzhu="month">月柱</div>
            <div class="zhuzhu-label" data-zhuzhu="day">日柱</div>
            <div class="zhuzhu-label" data-zhuzhu="hour">时柱</div>
            <div class="zhuzhu-label" data-zhuzhu="d大运">大运</div>
            <div class="zhuzhu-label" data-zhuzhu="d流年">流年</div>
        </div>
        
        <!-- 天干按钮 -->
        <div class="tiangan-buttons">
            <div class="circle-button" data-zhuzhu="year" data-type="tiangan">天干</div>
            <div class="circle-button" data-zhuzhu="month" data-type="tiangan">天干</div>
            <div class="circle-button" data-zhuzhu="day" data-type="tiangan">天干</div>
            <div class="circle-button" data-zhuzhu="hour" data-type="tiangan">天干</div>
            <div class="circle-button" data-zhuzhu="d大运" data-type="tiangan">天干</div>
            <div class="circle-button" data-zhuzhu="d流年" data-type="tiangan">天干</div>
        </div>
        
        <!-- 地支按钮 -->
        <div class="dizhi-buttons">
            <div class="circle-button" data-zhuzhu="year" data-type="dizhi">地支</div>
            <div class="circle-button" data-zhuzhu="month" data-type="dizhi">地支</div>
            <div class="circle-button" data-zhuzhu="day" data-type="dizhi">地支</div>
            <div class="circle-button" data-zhuzhu="hour" data-type="dizhi">地支</div>
            <div class="circle-button" data-zhuzhu="d大运" data-type="dizhi">地支</div>
            <div class="circle-button" data-zhuzhu="d流年" data-type="dizhi">地支</div>
        </div>
        
        <div class="range-info">查找范围：1801-2099年</div>
        
        <div class="flex gap-3 justify-center">
            <button class="confirm-button primary-button">确定</button>
            <button class="confirm-button secondary-button">清空八字</button>
        </div>
        
        <div class="flex gap-3 justify-center" style="margin-top: 20px;">
            <button class="confirm-button primary-button">保存案例</button>
            <button class="confirm-button primary-button">案例库</button>
        </div>
        
        <!-- 结果展示 -->
        <div class="result">
            <h2>排盘结果</h2>
            <div id="result-content">
                <!-- 结果将在这里显示 -->
            </div>
        </div>
    </div>
    
    <!-- 天干选择弹窗 -->
    <div class="tiangan-popup">
        <div class="popup-header">
            <h3>选择天干</h3>
            <span class="none-btn">无</span>
            <span class="close-btn">&times;</span>
        </div>
        <div class="tiangan-grid">
            <div class="tiangan-item" data-value="甲">甲</div>
            <div class="tiangan-item" data-value="乙">乙</div>
            <div class="tiangan-item" data-value="丙">丙</div>
            <div class="tiangan-item" data-value="丁">丁</div>
            <div class="tiangan-item" data-value="戊">戊</div>
            <div class="tiangan-item" data-value="己">己</div>
            <div class="tiangan-item" data-value="庚">庚</div>
            <div class="tiangan-item" data-value="辛">辛</div>
            <div class="tiangan-item" data-value="壬">壬</div>
            <div class="tiangan-item" data-value="癸">癸</div>
        </div>
    </div>
    
    <!-- 地支选择弹窗 -->
    <div class="dizhi-popup">
        <div class="popup-header">
            <h3>选择地支</h3>
            <span class="none-btn">无</span>
            <span class="close-btn">&times;</span>
        </div>
        <div class="dizhi-grid">
            <div class="dizhi-item" data-value="子">子</div>
            <div class="dizhi-item" data-value="丑">丑</div>
            <div class="dizhi-item" data-value="寅">寅</div>
            <div class="dizhi-item" data-value="卯">卯</div>
            <div class="dizhi-item" data-value="辰">辰</div>
            <div class="dizhi-item" data-value="巳">巳</div>
            <div class="dizhi-item" data-value="午">午</div>
            <div class="dizhi-item" data-value="未">未</div>
            <div class="dizhi-item" data-value="申">申</div>
            <div class="dizhi-item" data-value="酉">酉</div>
            <div class="dizhi-item" data-value="戌">戌</div>
            <div class="dizhi-item" data-value="亥">亥</div>
        </div>
    </div>
    
    <!-- 遮罩层 -->
    <div class="overlay"></div>
    
    <!-- 案例库弹窗 -->
    <div class="case-library-popup">
        <div class="popup-header">
            <h3>案例库</h3>
            <span class="close-btn">&times;</span>
        </div>
        
        <!-- 案例搜索 -->
        <div class="case-search">
            <h4>案例搜索</h4>
            <div class="search-container">
                <input type="text" id="case-search-input" placeholder="输入关键词搜索案例（可搜索标题、问题、宫位等）">
                <button id="case-search-btn" class="primary-button">搜索</button>
                <button id="case-reset-btn" class="success-button">重置</button>
            </div>
            <p class="search-hint">搜索提示：可搜索标题、问题、宫位名称等内容</p>
        </div>
        
        <!-- 案例列表 -->
        <div class="case-list">
            <h4>案例列表</h4>
            <div id="case-list-container">
                <!-- 案例项将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 保存案例弹窗 -->
    <div class="save-case-popup">
        <div class="popup-header">
            <h3>保存案例</h3>
            <span class="close-btn">&times;</span>
        </div>
        
        <div class="save-form">
            <div class="form-group">
                <label for="case-name">案例名称</label>
                <input type="text" id="case-name" placeholder="请输入案例名称">
            </div>
            
            <div class="form-group">
                <label for="case-note">备注信息</label>
                <textarea id="case-note" placeholder="请输入备注信息（可选）"></textarea>
            </div>
            
            <div class="form-actions">
                <button id="cancel-save-btn" class="secondary-button">取消</button>
                <button id="confirm-save-btn" class="primary-button">保存</button>
            </div>
        </div>
    </div>
    
    <script>
        // 天干地支阴阳属性
        const YIN_YANG = {
            tiangan: {
                '甲': '阳', '乙': '阴', '丙': '阳', '丁': '阴',
                '戊': '阳', '己': '阴', '庚': '阳', '辛': '阴',
                '壬': '阳', '癸': '阴'
            },
            dizhi: {
                '子': '阳', '丑': '阴', '寅': '阳', '卯': '阴',
                '辰': '阳', '巳': '阴', '午': '阳', '未': '阴',
                '申': '阳', '酉': '阴', '戌': '阳', '亥': '阴'
            }
        };
        
        // 全局变量
        let selectedValues = {
            year: { tiangan: '', dizhi: '' },
            month: { tiangan: '', dizhi: '' },
            day: { tiangan: '', dizhi: '' },
            hour: { tiangan: '', dizhi: '' },
            'd大运': { tiangan: '', dizhi: '' },
            'd流年': { tiangan: '', dizhi: '' }
        };
        
        let currentZhuzhu = 'year'; // 当前选中的柱（年柱、月柱、日柱、时柱）
        
        // 案例存储相关常量
        const CASE_STORAGE_KEY = 'bazi_cases';
        
        // 初始化案例存储
        function initCaseStorage() {
            if (!localStorage.getItem(CASE_STORAGE_KEY)) {
                localStorage.setItem(CASE_STORAGE_KEY, JSON.stringify([]));
            }
        }
        
        // 获取所有案例
        function getAllCases() {
            initCaseStorage();
            return JSON.parse(localStorage.getItem(CASE_STORAGE_KEY) || '[]');
        }
        
        // 保存案例
        function saveCase(caseData) {
            const cases = getAllCases();
            cases.push(caseData);
            localStorage.setItem(CASE_STORAGE_KEY, JSON.stringify(cases));
        }
        
        // 删除案例
        function deleteCase(caseId) {
            const cases = getAllCases();
            const filteredCases = cases.filter(c => c.id !== caseId);
            localStorage.setItem(CASE_STORAGE_KEY, JSON.stringify(filteredCases));
        }
        
        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // 格式化日期
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        // 绑定弹窗事件
        function bindPopupEvents() {
            // 天干选择
            const tianganItems = document.querySelectorAll('.tiangan-item');
            tianganItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 跳过禁用的天干
                    if (this.classList.contains('disabled')) {
                        return;
                    }
                    
                    const value = this.getAttribute('data-value');
                    selectedValues[currentZhuzhu].tiangan = value;
                    updateButtonStates();
                    hidePopup();
                });
            });
            
            // 地支选择
            const dizhiItems = document.querySelectorAll('.dizhi-item');
            dizhiItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 跳过禁用的地支
                    if (this.classList.contains('disabled')) {
                        return;
                    }
                    
                    const value = this.getAttribute('data-value');
                    selectedValues[currentZhuzhu].dizhi = value;
                    updateButtonStates();
                    hidePopup();
                });
            });
            
            // 关闭按钮
            const closeBtns = document.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', hidePopup);
            });
            
            // 无选项按钮
            const noneBtns = document.querySelectorAll('.none-btn');
            noneBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 确定当前是天干还是地支弹窗
                    const popup = this.closest('.tiangan-popup, .dizhi-popup');
                    if (popup.classList.contains('tiangan-popup')) {
                        selectedValues[currentZhuzhu].tiangan = '';
                    } else if (popup.classList.contains('dizhi-popup')) {
                        selectedValues[currentZhuzhu].dizhi = '';
                    }
                    updateButtonStates();
                    hidePopup();
                });
            });
            
            // 遮罩层
            const overlay = document.querySelector('.overlay');
            overlay.addEventListener('click', hidePopup);
        }
        
        // 初始化
        function init() {
            // 绑定圆形按钮点击事件
            bindCircleButtonEvents();
            
            // 绑定确定按钮点击事件
            bindConfirmButtonEvent();
            
            // 绑定弹窗事件
            bindPopupEvents();
            
            // 绑定案例相关事件
            bindCaseEvents();
            
            // 初始化案例存储
            initCaseStorage();
            
            // 初始化按钮状态
            updateButtonStates();
        }
        
        // 加载案例列表
        function loadCaseList() {
            const caseContainer = document.getElementById('case-list-container');
            const cases = getAllCases();
            
            // 清空容器
            caseContainer.innerHTML = '';
            
            if (cases.length === 0) {
                caseContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无案例，请先保存案例</div>';
                return;
            }
            
            // 按保存时间倒序排列
            cases.sort((a, b) => new Date(b.saveTime) - new Date(a.saveTime));
            
            // 生成案例列表
            cases.forEach(caseData => {
                const caseElement = document.createElement('div');
                caseElement.style.cssText = 'padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: flex-start;';
                caseElement.style.backgroundColor = '#f9f9f9';
                
                caseElement.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f0f0f0';
                });
                
                caseElement.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#f9f9f9';
                });
                
                // 案例内容
                const caseContent = document.createElement('div');
                caseContent.style.flex = '1';
                
                const caseName = document.createElement('h4');
                caseName.style.margin = '0 0 5px 0';
                caseName.style.color = '#333';
                caseName.textContent = caseData.name;
                
                const caseTime = document.createElement('p');
                caseTime.style.margin = '0 0 5px 0';
                caseTime.style.fontSize = '12px';
                caseTime.style.color = '#999';
                caseTime.textContent = `保存时间：${formatDate(new Date(caseData.saveTime))}`;
                
                const caseNote = document.createElement('p');
                caseNote.style.margin = '0';
                caseNote.style.fontSize = '14px';
                caseNote.style.color = '#666';
                caseNote.textContent = caseData.note || '无备注';
                
                // 八字简要信息
                const baziInfo = document.createElement('p');
                baziInfo.style.margin = '5px 0 0 0';
                baziInfo.style.fontSize = '12px';
                baziInfo.style.color = '#666';
                
                const yearBazi = caseData.baziData.year.tiangan + caseData.baziData.year.dizhi || '--';
                const monthBazi = caseData.baziData.month.tiangan + caseData.baziData.month.dizhi || '--';
                const dayBazi = caseData.baziData.day.tiangan + caseData.baziData.day.dizhi || '--';
                const hourBazi = caseData.baziData.hour.tiangan + caseData.baziData.hour.dizhi || '--';
                
                baziInfo.textContent = `八字：${yearBazi} ${monthBazi} ${dayBazi} ${hourBazi}`;
                
                caseContent.appendChild(caseName);
                caseContent.appendChild(caseTime);
                caseContent.appendChild(caseNote);
                caseContent.appendChild(baziInfo);
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '删除';
                deleteBtn.className = 'error-button';
                deleteBtn.style.cssText = 'padding: 4px 12px; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 12px; margin-left: 10px;';
                deleteBtn.style.marginLeft = '10px';
                
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止冒泡
                    if (confirm('确定要删除这个案例吗？')) {
                        deleteCase(caseData.id);
                        loadCaseList(); // 重新加载案例列表
                    }
                });
                
                // 组装案例元素
                caseElement.appendChild(caseContent);
                caseElement.appendChild(deleteBtn);
                
                // 点击案例加载数据
                caseElement.addEventListener('click', function() {
                    loadCaseData(caseData.baziData);
                    hideAllPopups();
                });
                
                caseContainer.appendChild(caseElement);
            });
        }
        
        // 筛选案例
        function filterCases(searchTerm) {
            const caseContainer = document.getElementById('case-list-container');
            const cases = getAllCases();
            
            // 清空容器
            caseContainer.innerHTML = '';
            
            if (!searchTerm) {
                loadCaseList();
                return;
            }
            
            // 筛选案例
            const filteredCases = cases.filter(caseData => {
                return (
                    caseData.name.toLowerCase().includes(searchTerm) ||
                    (caseData.note && caseData.note.toLowerCase().includes(searchTerm)) ||
                    JSON.stringify(caseData.baziData).toLowerCase().includes(searchTerm)
                );
            });
            
            if (filteredCases.length === 0) {
                caseContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">未找到匹配的案例</div>';
                return;
            }
            
            // 按保存时间倒序排列
            filteredCases.sort((a, b) => new Date(b.saveTime) - new Date(a.saveTime));
            
            // 生成筛选后的案例列表
            filteredCases.forEach(caseData => {
                const caseElement = document.createElement('div');
                caseElement.style.cssText = 'padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: flex-start;';
                caseElement.style.backgroundColor = '#f9f9f9';
                
                caseElement.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f0f0f0';
                });
                
                caseElement.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#f9f9f9';
                });
                
                // 案例内容
                const caseContent = document.createElement('div');
                caseContent.style.flex = '1';
                
                const caseName = document.createElement('h4');
                caseName.style.margin = '0 0 5px 0';
                caseName.style.color = '#333';
                caseName.textContent = caseData.name;
                
                const caseTime = document.createElement('p');
                caseTime.style.margin = '0 0 5px 0';
                caseTime.style.fontSize = '12px';
                caseTime.style.color = '#999';
                caseTime.textContent = `保存时间：${formatDate(new Date(caseData.saveTime))}`;
                
                const caseNote = document.createElement('p');
                caseNote.style.margin = '0';
                caseNote.style.fontSize = '14px';
                caseNote.style.color = '#666';
                caseNote.textContent = caseData.note || '无备注';
                
                // 八字简要信息
                const baziInfo = document.createElement('p');
                baziInfo.style.margin = '5px 0 0 0';
                baziInfo.style.fontSize = '12px';
                baziInfo.style.color = '#666';
                
                const yearBazi = caseData.baziData.year.tiangan + caseData.baziData.year.dizhi || '--';
                const monthBazi = caseData.baziData.month.tiangan + caseData.baziData.month.dizhi || '--';
                const dayBazi = caseData.baziData.day.tiangan + caseData.baziData.day.dizhi || '--';
                const hourBazi = caseData.baziData.hour.tiangan + caseData.baziData.hour.dizhi || '--';
                
                baziInfo.textContent = `八字：${yearBazi} ${monthBazi} ${dayBazi} ${hourBazi}`;
                
                caseContent.appendChild(caseName);
                caseContent.appendChild(caseTime);
                caseContent.appendChild(caseNote);
                caseContent.appendChild(baziInfo);
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '删除';
                deleteBtn.className = 'error-button';
                deleteBtn.style.cssText = 'padding: 4px 12px; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 12px; margin-left: 10px;';
                deleteBtn.style.marginLeft = '10px';
                
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止冒泡
                    if (confirm('确定要删除这个案例吗？')) {
                        deleteCase(caseData.id);
                        loadCaseList(); // 重新加载案例列表
                    }
                });
                
                // 组装案例元素
                caseElement.appendChild(caseContent);
                caseElement.appendChild(deleteBtn);
                
                // 点击案例加载数据
                caseElement.addEventListener('click', function() {
                    loadCaseData(caseData.baziData);
                    hideAllPopups();
                });
                
                caseContainer.appendChild(caseElement);
            });
        }
        
        // 加载案例数据
        function loadCaseData(baziData) {
            // 恢复八字数据
            selectedValues = JSON.parse(JSON.stringify(baziData));
            
            // 更新按钮状态
            updateButtonStates();
            
            // 自动计算并显示排盘结果
            const bazi = {
                year: selectedValues.year.tiangan + selectedValues.year.dizhi,
                month: selectedValues.month.tiangan + selectedValues.month.dizhi,
                day: selectedValues.day.tiangan + selectedValues.day.dizhi,
                hour: selectedValues.hour.tiangan + selectedValues.hour.dizhi,
                d大运: selectedValues['d大运'].tiangan + selectedValues['d大运'].dizhi,
                d流年: selectedValues['d流年'].tiangan + selectedValues['d流年'].dizhi,
                yearTiangan: selectedValues.year.tiangan,
                yearDizhi: selectedValues.year.dizhi,
                monthTiangan: selectedValues.month.tiangan,
                monthDizhi: selectedValues.month.dizhi,
                dayTiangan: selectedValues.day.tiangan,
                dayDizhi: selectedValues.day.dizhi,
                hourTiangan: selectedValues.hour.tiangan,
                hourDizhi: selectedValues.hour.dizhi,
                d大运Tiangan: selectedValues['d大运'].tiangan,
                d大运Dizhi: selectedValues['d大运'].dizhi,
                d流年Tiangan: selectedValues['d流年'].tiangan,
                d流年Dizhi: selectedValues['d流年'].dizhi
            };
            
            const shishen = calculateShishen(bazi);
            displayResult(bazi, shishen);
            
            // 强制显示结果区域
            const resultSection = document.querySelector('.result');
            resultSection.style.display = 'block';
        }
        
        // 绑定圆形按钮点击事件
        function bindCircleButtonEvents() {
            const buttons = document.querySelectorAll('.circle-button');
            
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const zhuzhu = this.getAttribute('data-zhuzhu');
                    const type = this.getAttribute('data-type');
                    
                    currentZhuzhu = zhuzhu;
                    
                    if (type === 'tiangan') {
                        showTianganPopup();
                    } else if (type === 'dizhi') {
                        showDizhiPopup();
                    }
                });
            });
        }
        
        // 显示天干选择弹窗
        function showTianganPopup() {
            const popup = document.querySelector('.tiangan-popup');
            const overlay = document.querySelector('.overlay');
            const tianganGrid = document.querySelector('.tiangan-grid');
            const selectedDizhi = selectedValues[currentZhuzhu].dizhi;
            
            // 清空网格
            tianganGrid.innerHTML = '';
            
            // 所有天干
            const allTiangan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            
            // 筛选符合阴阳匹配规则的天干
            const filteredTiangan = allTiangan.filter(tiangan => {
                if (!selectedDizhi) {
                    return true; // 没有选地支时显示所有天干
                }
                const dizhiYinYang = YIN_YANG.dizhi[selectedDizhi];
                const tianganYinYang = YIN_YANG.tiangan[tiangan];
                return dizhiYinYang === tianganYinYang;
            });
            
            // 创建并添加天干选项
            filteredTiangan.forEach(tiangan => {
                const tianganItem = document.createElement('div');
                tianganItem.className = 'tiangan-item';
                tianganItem.setAttribute('data-value', tiangan);
                tianganItem.textContent = tiangan;
                
                // 设置选中状态
                if (tiangan === selectedValues[currentZhuzhu].tiangan) {
                    tianganItem.classList.add('active');
                }
                
                // 添加点击事件
                tianganItem.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    selectedValues[currentZhuzhu].tiangan = value;
                    updateButtonStates();
                    hidePopup();
                });
                
                tianganGrid.appendChild(tianganItem);
            });
            
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // 显示地支选择弹窗
        function showDizhiPopup() {
            const popup = document.querySelector('.dizhi-popup');
            const overlay = document.querySelector('.overlay');
            const dizhiGrid = document.querySelector('.dizhi-grid');
            const selectedTiangan = selectedValues[currentZhuzhu].tiangan;
            
            // 清空网格
            dizhiGrid.innerHTML = '';
            
            // 所有地支
            const allDizhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            // 筛选符合阴阳匹配规则的地支
            const filteredDizhi = allDizhi.filter(dizhi => {
                if (!selectedTiangan) {
                    return true; // 没有选天干时显示所有地支
                }
                const tianganYinYang = YIN_YANG.tiangan[selectedTiangan];
                const dizhiYinYang = YIN_YANG.dizhi[dizhi];
                return tianganYinYang === dizhiYinYang;
            });
            
            // 创建并添加地支选项
            filteredDizhi.forEach(dizhi => {
                const dizhiItem = document.createElement('div');
                dizhiItem.className = 'dizhi-item';
                dizhiItem.setAttribute('data-value', dizhi);
                dizhiItem.textContent = dizhi;
                
                // 设置选中状态
                if (dizhi === selectedValues[currentZhuzhu].dizhi) {
                    dizhiItem.classList.add('active');
                }
                
                // 添加点击事件
                dizhiItem.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    selectedValues[currentZhuzhu].dizhi = value;
                    updateButtonStates();
                    hidePopup();
                });
                
                dizhiGrid.appendChild(dizhiItem);
            });
            
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // 隐藏弹窗
        function hidePopup() {
            const popups = document.querySelectorAll('.tiangan-popup, .dizhi-popup');
            const overlay = document.querySelector('.overlay');
            
            popups.forEach(popup => {
                popup.style.display = 'none';
            });
            
            overlay.style.display = 'none';
        }
        
        // 重置单个值
        function resetValue(zhuzhu, type) {
            selectedValues[zhuzhu][type] = '';
            updateButtonStates();
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            const buttons = document.querySelectorAll('.circle-button');
            
            buttons.forEach(button => {
                const zhuzhu = button.getAttribute('data-zhuzhu');
                const type = button.getAttribute('data-type');
                
                // 清空按钮内部内容
                button.innerHTML = '';
                
                if (type === 'tiangan') {
                    if (selectedValues[zhuzhu].tiangan) {
                        button.textContent = selectedValues[zhuzhu].tiangan;
                        button.classList.add('active');
                        
                        // 添加重置按钮
                        const resetBtn = document.createElement('span');
                        resetBtn.className = 'reset-btn';
                        resetBtn.textContent = '×';
                        resetBtn.style.position = 'absolute';
                        resetBtn.style.top = '5px';
                        resetBtn.style.right = '5px';
                        resetBtn.style.fontSize = '12px';
                        resetBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                        resetBtn.style.borderRadius = '50%';
                        resetBtn.style.width = '16px';
                        resetBtn.style.height = '16px';
                        resetBtn.style.display = 'flex';
                        resetBtn.style.alignItems = 'center';
                        resetBtn.style.justifyContent = 'center';
                        resetBtn.style.cursor = 'pointer';
                        resetBtn.style.color = '#999';
                        resetBtn.onclick = function(e) {
                            e.stopPropagation();
                            resetValue(zhuzhu, 'tiangan');
                        };
                        button.style.position = 'relative';
                        button.appendChild(resetBtn);
                    } else {
                        button.textContent = '天干';
                        button.classList.remove('active');
                    }
                } else if (type === 'dizhi') {
                    if (selectedValues[zhuzhu].dizhi) {
                        button.textContent = selectedValues[zhuzhu].dizhi;
                        button.classList.add('active');
                        
                        // 添加重置按钮
                        const resetBtn = document.createElement('span');
                        resetBtn.className = 'reset-btn';
                        resetBtn.textContent = '×';
                        resetBtn.style.position = 'absolute';
                        resetBtn.style.top = '5px';
                        resetBtn.style.right = '5px';
                        resetBtn.style.fontSize = '12px';
                        resetBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                        resetBtn.style.borderRadius = '50%';
                        resetBtn.style.width = '16px';
                        resetBtn.style.height = '16px';
                        resetBtn.style.display = 'flex';
                        resetBtn.style.alignItems = 'center';
                        resetBtn.style.justifyContent = 'center';
                        resetBtn.style.cursor = 'pointer';
                        resetBtn.style.color = '#999';
                        resetBtn.onclick = function(e) {
                            e.stopPropagation();
                            resetValue(zhuzhu, 'dizhi');
                        };
                        button.style.position = 'relative';
                        button.appendChild(resetBtn);
                    } else {
                        button.textContent = '地支';
                        button.classList.remove('active');
                    }
                }
            });
        }
        
        // 生成随机八字
        function generateRandomBazi() {
            const tiangan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const dizhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            // 地支阴阳属性
            const dizhiYinYang = {
                '子': '阳', '丑': '阴',
                '寅': '阳', '卯': '阴',
                '辰': '阳', '巳': '阴',
                '午': '阳', '未': '阴',
                '申': '阳', '酉': '阴',
                '戌': '阳', '亥': '阴'
            };
            
            // 随机生成八字
            selectedValues = {
                year: { tiangan: '', dizhi: '' },
                month: { tiangan: '', dizhi: '' },
                day: { tiangan: '', dizhi: '' },
                hour: { tiangan: '', dizhi: '' },
                'd大运': { tiangan: '', dizhi: '' },
                'd流年': { tiangan: '', dizhi: '' }
            };
            
            // 为每个柱生成随机天干地支
            Object.keys(selectedValues).forEach(zhuzhu => {
                // 随机选择天干
                const randomTiangan = tiangan[Math.floor(Math.random() * tiangan.length)];
                selectedValues[zhuzhu].tiangan = randomTiangan;
                
                // 根据天干阴阳选择对应阴阳的地支
                const tianganIndex = tiangan.indexOf(randomTiangan);
                const isTianganYang = tianganIndex % 2 === 0;
                
                // 筛选出与天干阴阳匹配的地支
                const compatibleDizhi = dizhi.filter(d => {
                    const isDizhiYang = dizhiYinYang[d] === '阳';
                    return isTianganYang === isDizhiYang;
                });
                
                // 从匹配的地支中随机选择一个
                const randomDizhi = compatibleDizhi[Math.floor(Math.random() * compatibleDizhi.length)];
                selectedValues[zhuzhu].dizhi = randomDizhi;
            });
            
            // 更新按钮状态
            updateButtonStates();
        }
        
        // 清空八字函数
        function clearBazi() {
            selectedValues = {
                year: { tiangan: '', dizhi: '' },
                month: { tiangan: '', dizhi: '' },
                day: { tiangan: '', dizhi: '' },
                hour: { tiangan: '', dizhi: '' },
                'd大运': { tiangan: '', dizhi: '' },
                'd流年': { tiangan: '', dizhi: '' }
            };
            updateButtonStates();
        }
        
        // 绑定确定按钮点击事件
        function bindConfirmButtonEvent() {
            const confirmButtons = document.querySelectorAll('.confirm-button');
            
            if (!confirmButtons || confirmButtons.length === 0) {
                alert('确认按钮未找到！');
                return;
            }
            
            // 为第一个按钮（确定按钮）绑定事件
            confirmButtons[0].addEventListener('click', function() {
                // 构建八字数据
                const bazi = {
                    year: selectedValues.year.tiangan + selectedValues.year.dizhi,
                    month: selectedValues.month.tiangan + selectedValues.month.dizhi,
                    day: selectedValues.day.tiangan + selectedValues.day.dizhi,
                    hour: selectedValues.hour.tiangan + selectedValues.hour.dizhi,
                    d大运: selectedValues['d大运'].tiangan + selectedValues['d大运'].dizhi,
                    d流年: selectedValues['d流年'].tiangan + selectedValues['d流年'].dizhi,
                    yearTiangan: selectedValues.year.tiangan,
                    yearDizhi: selectedValues.year.dizhi,
                    monthTiangan: selectedValues.month.tiangan,
                    monthDizhi: selectedValues.month.dizhi,
                    dayTiangan: selectedValues.day.tiangan,
                    dayDizhi: selectedValues.day.dizhi,
                    hourTiangan: selectedValues.hour.tiangan,
                    hourDizhi: selectedValues.hour.dizhi,
                    d大运Tiangan: selectedValues['d大运'].tiangan,
                    d大运Dizhi: selectedValues['d大运'].dizhi,
                    d流年Tiangan: selectedValues['d流年'].tiangan,
                    d流年Dizhi: selectedValues['d流年'].dizhi
                };
                
                // 计算十神关系
                console.log('开始计算十神关系');
                console.log('八字数据:', bazi);
                const shishen = calculateShishen(bazi);
                console.log('十神结果:', shishen);
                
                // 显示结果
                console.log('开始显示结果');
                displayResult(bazi, shishen);
                console.log('结果显示完成');
                
                // 强制显示结果区域
                const resultSection = document.querySelector('.result');
                resultSection.style.display = 'block';
                console.log('结果区域显示状态:', resultSection.style.display);
            });
            
            // 为第二个按钮（清空八字按钮）绑定事件
            if (confirmButtons.length > 1) {
                confirmButtons[1].addEventListener('click', clearBazi);
            }
            
            // 为第三个按钮（保存案例按钮）绑定事件
            if (confirmButtons.length > 2) {
                confirmButtons[2].addEventListener('click', function() {
                    showSaveCasePopup();
                });
            }
            
            // 为第四个按钮（案例库按钮）绑定事件
            if (confirmButtons.length > 3) {
                confirmButtons[3].addEventListener('click', function() {
                    showCaseLibraryPopup();
                });
            }
        }
        
        // 显示保存案例弹窗
        function showSaveCasePopup() {
            const popup = document.querySelector('.save-case-popup');
            const overlay = document.querySelector('.overlay');
            
            // 清空表单
            document.getElementById('case-name').value = '';
            document.getElementById('case-note').value = '';
            
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // 显示案例库弹窗
        function showCaseLibraryPopup() {
            const popup = document.querySelector('.case-library-popup');
            const overlay = document.querySelector('.overlay');
            
            // 加载案例列表
            loadCaseList();
            
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // 隐藏所有弹窗
        function hideAllPopups() {
            const popups = document.querySelectorAll('.tiangan-popup, .dizhi-popup, .save-case-popup, .case-library-popup');
            const overlay = document.querySelector('.overlay');
            
            popups.forEach(popup => {
                popup.style.display = 'none';
            });
            
            overlay.style.display = 'none';
        }
        
        // 绑定案例相关事件
        function bindCaseEvents() {
            // 保存案例弹窗关闭按钮
            document.querySelector('.save-case-popup .close-btn').addEventListener('click', hideAllPopups);
            
            // 案例库弹窗关闭按钮
            document.querySelector('.case-library-popup .close-btn').addEventListener('click', hideAllPopups);
            
            // 取消保存按钮
            document.getElementById('cancel-save-btn').addEventListener('click', hideAllPopups);
            
            // 确认保存按钮
            document.getElementById('confirm-save-btn').addEventListener('click', function() {
                const caseName = document.getElementById('case-name').value.trim();
                const caseNote = document.getElementById('case-note').value.trim();
                
                if (!caseName) {
                    alert('请输入案例名称');
                    return;
                }
                
                // 构建案例数据
                const caseData = {
                    id: generateId(),
                    name: caseName,
                    note: caseNote,
                    saveTime: new Date().toISOString(),
                    baziData: JSON.parse(JSON.stringify(selectedValues)) // 深拷贝八字数据
                };
                
                // 保存案例
                saveCase(caseData);
                
                // 显示成功提示
                alert('案例保存成功！');
                
                // 关闭弹窗
                hideAllPopups();
            });
            
            // 案例搜索按钮
            document.getElementById('case-search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('case-search-input').value.trim().toLowerCase();
                filterCases(searchTerm);
            });
            
            // 案例重置按钮
            document.getElementById('case-reset-btn').addEventListener('click', function() {
                document.getElementById('case-search-input').value = '';
                loadCaseList();
            });
            
            // 案例搜索输入框回车事件
            document.getElementById('case-search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim().toLowerCase();
                    filterCases(searchTerm);
                }
            });
            
            // 遮罩层点击事件
            document.querySelector('.overlay').addEventListener('click', hideAllPopups);
        }
        
        // 五行对应关系
        const WUXING = {
            '甲': 'wood', '乙': 'wood',
            '丙': 'fire', '丁': 'fire',
            '戊': 'earth', '己': 'earth',
            '庚': 'metal', '辛': 'metal',
            '壬': 'water', '癸': 'water',
            '子': 'water', '丑': 'earth',
            '寅': 'wood', '卯': 'wood',
            '辰': 'earth', '巳': 'fire',
            '午': 'fire', '未': 'earth',
            '申': 'metal', '酉': 'metal',
            '戌': 'earth', '亥': 'water'
        };
        
        // 五行相生相克关系
        const WU_XING_Sheng = {
            'wood': 'fire',
            'fire': 'earth',
            'earth': 'metal',
            'metal': 'water',
            'water': 'wood'
        };
        
        const WU_XING_K = {
            'wood': 'earth',
            'earth': 'water',
            'water': 'fire',
            'fire': 'metal',
            'metal': 'wood'
        };
        
        // 计算十神关系
        function calculateShishen(bazi) {
            const dayTiangan = bazi.dayTiangan;
            
            return {
                year: {
                    tiangan: getShishenName(dayTiangan, bazi.yearTiangan),
                    dizhi: calculateDizhiShishen(dayTiangan, bazi.yearDizhi)
                },
                month: {
                    tiangan: getShishenName(dayTiangan, bazi.monthTiangan),
                    dizhi: calculateDizhiShishen(dayTiangan, bazi.monthDizhi)
                },
                day: {
                    tiangan: '日元',
                    dizhi: calculateDizhiShishen(dayTiangan, bazi.dayDizhi)
                },
                hour: {
                    tiangan: getShishenName(dayTiangan, bazi.hourTiangan),
                    dizhi: calculateDizhiShishen(dayTiangan, bazi.hourDizhi)
                },
                'd大运': {
                    tiangan: getShishenName(dayTiangan, bazi.d大运Tiangan),
                    dizhi: calculateDizhiShishen(dayTiangan, bazi.d大运Dizhi)
                },
                'd流年': {
                    tiangan: getShishenName(dayTiangan, bazi.d流年Tiangan),
                    dizhi: calculateDizhiShishen(dayTiangan, bazi.d流年Dizhi)
                }
            };
        }
        
        // 获取十神名称
        function getShishenName(dayMaster, otherTiangan) {
            const tianganOrder = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const dayMasterIndex = tianganOrder.indexOf(dayMaster);
            const otherIndex = tianganOrder.indexOf(otherTiangan);
            
            // 检查是否找到天干
            if (dayMasterIndex === -1 || otherIndex === -1) {
                return '未知';
            }
            
            // 判断阴阳属性
            const isDayMasterYang = dayMasterIndex % 2 === 0;
            const isOtherYang = otherIndex % 2 === 0;
            
            // 计算五行生克关系
            const dayMasterElement = WUXING[dayMaster];
            const otherElement = WUXING[otherTiangan];
            
            // 同五行：比劫
            if (otherElement === dayMasterElement) {
                return isDayMasterYang === isOtherYang ? '比肩' : '劫财';
            }
            
            // 生我：印绶（其他天干生日主）
            if (WU_XING_Sheng[otherElement] === dayMasterElement) {
                return isDayMasterYang !== isOtherYang ? '正印' : '偏印';
            }
            
            // 我生：食伤（日主生其他天干）
            if (WU_XING_Sheng[dayMasterElement] === otherElement) {
                return isDayMasterYang === isOtherYang ? '食神' : '伤官';
            }
            
            // 克我：官杀（其他天干克日主）
            if (WU_XING_K[otherElement] === dayMasterElement) {
                return isDayMasterYang !== isOtherYang ? '正官' : '七杀';
            }
            
            // 我克：财星（日主克其他天干）
            if (WU_XING_K[dayMasterElement] === otherElement) {
                return isDayMasterYang !== isOtherYang ? '正财' : '偏财';
            }
            
            // 默认返回
            return '未知';
        }
        
        // 计算地支十神
        function calculateDizhiShishen(dayMaster, dizhi) {
            // 地支的五行属性
            const dizhiElement = WUXING[dizhi];
            
            // 阳地支：子、寅、辰、午、申、戌
            // 阴地支：丑、卯、巳、未、酉、亥
            const yangDizhi = ['子', '寅', '辰', '午', '申', '戌'];
            const isDizhiYang = yangDizhi.includes(dizhi);
            
            // 日干的五行属性
            const dayMasterElement = WUXING[dayMaster];
            
            // 日干的阴阳属性
            const tianganOrder = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const dayMasterIndex = tianganOrder.indexOf(dayMaster);
            const isDayMasterYang = dayMasterIndex % 2 === 0;
            
            // 同五行：比劫
            if (dizhiElement === dayMasterElement) {
                return isDayMasterYang === isDizhiYang ? '比肩' : '劫财';
            }
            
            // 生我：印绶（其他天干生日主）
            if (WU_XING_Sheng[dizhiElement] === dayMasterElement) {
                return isDayMasterYang !== isDizhiYang ? '正印' : '偏印';
            }
            
            // 我生：食伤（日主生其他天干）
            if (WU_XING_Sheng[dayMasterElement] === dizhiElement) {
                return isDayMasterYang === isDizhiYang ? '食神' : '伤官';
            }
            
            // 克我：官杀（其他天干克日主）
            if (WU_XING_K[dizhiElement] === dayMasterElement) {
                return isDayMasterYang !== isDizhiYang ? '正官' : '七杀';
            }
            
            // 我克：财星（日主克其他天干）
            if (WU_XING_K[dayMasterElement] === dizhiElement) {
                return isDayMasterYang !== isDizhiYang ? '正财' : '偏财';
            }
            
            // 默认返回
            return '未知';
        }
        
        // 定义十二地支数组
        const DI_ZHI = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        
        // 定义十二用神数组
        const SHI_SHEN_LIST = ['运气', '兄弟', '配偶', '子女', '财帛', '疾病', '迁移', '交友', '事业', '田宅', '福德', '父母'];
        
        // 计算关系（三合、六合或三会）
        function calculateRelation(daYunDizhi, liuNianDizhi, diPanDizhi) {
            // 六合检查：
            // 1. 如果有流年，则只与流年地支发生，与大运不会发生关系
            // 2. 如果没有排流年，则大运可以与地盘组成六合
            const liuhePairs = {
                '子': '丑',
                '丑': '子',
                '寅': '亥',
                '亥': '寅',
                '卯': '戌',
                '戌': '卯',
                '辰': '酉',
                '酉': '辰',
                '巳': '申',
                '申': '巳',
                '午': '未',
                '未': '午'
            };
            
            // 相冲检查：
            // 1. 如果有流年，则只与流年地支发生，与大运不会发生关系
            // 2. 如果没有排流年，则大运可以与地盘组成相冲
            const xiangchongPairs = {
                '子': '午',
                '午': '子',
                '丑': '未',
                '未': '丑',
                '寅': '申',
                '申': '寅',
                '卯': '酉',
                '酉': '卯',
                '辰': '戌',
                '戌': '辰',
                '巳': '亥',
                '亥': '巳'
            };
            
            // 相害检查：
            // 1. 如果有流年，则只与流年地支发生，与大运不会发生关系
            // 2. 如果没有排流年，则大运可以与地盘组成相害
            const xianghaiPairs = {
                '子': '未',
                '未': '子',
                '午': '丑',
                '丑': '午',
                '寅': '巳',
                '巳': '寅',
                '卯': '辰',
                '辰': '卯',
                '申': '亥',
                '亥': '申',
                '酉': '戌',
                '戌': '酉'
            };
            
            // 相破检查：
            // 1. 如果有流年，则只与流年地支发生，与大运不会发生关系
            // 2. 如果没有排流年，则大运可以与地盘组成相破
            const xiangpoPairs = {
                '子': '酉',
                '酉': '子',
                '丑': '辰',
                '辰': '丑',
                '寅': '亥',
                '亥': '寅',
                '卯': '午',
                '午': '卯',
                '巳': '申',
                '申': '巳',
                '未': '戌',
                '戌': '未'
            };
            
            // 相刑检查：
            // 1. 如果有流年，则只与流年地支发生，与大运不会发生关系
            // 2. 如果没有排流年，则大运可以与地盘组成相刑
            const xiangxingPairs = {
                '子': '卯', '卯': '子',  // 子卯相刑
                '寅': '巳', '巳': '寅',  // 寅巳相刑
                '巳': '申', '申': '巳',  // 巳申相刑
                '寅': '申', '申': '寅',  // 寅申相刑
                '丑': '未', '未': '丑',  // 丑未相刑
                '未': '戌', '戌': '未',  // 未戌相刑
                '丑': '戌', '戌': '丑'   // 丑戌相刑
            };
            
            // 自刑检查：
            // 1. 如果有流年，则只与流年地支发生，与大运不会发生关系
            // 2. 如果没有排流年，则大运可以与地盘组成自刑
            const zixingDizhi = ['辰', '午', '酉', '亥']; // 自刑地支
            
            // 地支五行映射
            const dizhiWuxing = {
                '子': '水',
                '丑': '土',
                '寅': '木',
                '卯': '木',
                '辰': '土',
                '巳': '火',
                '午': '火',
                '未': '土',
                '申': '金',
                '酉': '金',
                '戌': '土',
                '亥': '水'
            };
            
            // 五行生克关系（使用英文五行名称，与WUXING对象匹配）
            const wuxingRelation = {
                '生': {
                    'metal': 'water',
                    'water': 'wood',
                    'wood': 'fire',
                    'fire': 'earth',
                    'earth': 'metal'
                },
                '克': {
                    'metal': 'wood',
                    'wood': 'earth',
                    'earth': 'water',
                    'water': 'fire',
                    'fire': 'metal'
                }
            };
            
            // 半合检查：一个盘中只有两个半合，由参考地支（流年或大运）和地盘地支组成
            const sanheGroups = {
                '申': ['子', '辰'], // 申的半合对象是子和辰
                '子': ['申', '辰'], // 子的半合对象是申和辰
                '辰': ['申', '子'], // 辰的半合对象是申和子
                '亥': ['卯', '未'], // 亥的半合对象是卯和未
                '卯': ['亥', '未'], // 卯的半合对象是亥和未
                '未': ['亥', '卯'], // 未的半合对象是亥和卯
                '寅': ['午', '戌'], // 寅的半合对象是午和戌
                '午': ['寅', '戌'], // 午的半合对象是寅和戌
                '戌': ['寅', '午'], // 戌的半合对象是寅和午
                '巳': ['酉', '丑'], // 巳的半合对象是酉和丑
                '酉': ['巳', '丑'], // 酉的半合对象是巳和丑
                '丑': ['巳', '酉']  // 丑的半合对象是巳和酉
            };
            
            // 确定参考地支
            const referenceDizhi = liuNianDizhi && liuNianDizhi !== '' ? liuNianDizhi : daYunDizhi;
            
            // 1. 三合检查
            const dizhis = [daYunDizhi, liuNianDizhi, diPanDizhi];
            const sanhe = {
                '申子辰': '三合',
                '亥卯未': '三合',
                '寅午戌': '三合',
                '巳酉丑': '三合'
            };
            
            const sanheKeys = Object.keys(sanhe);
            for (const key of sanheKeys) {
                const sanheDizhis = key.split('');
                if (sanheDizhis.every(dizhi => dizhis.includes(dizhi))) {
                    // 三合默认没有生克关系区分，保持原类型
                    return { type: sanhe[key], shengke: '无', color: '' };
                }
            }
            
            // 2. 三刑检查（与三合规则相同，需要大运地支+流年地支+地盘地支组成三刑）
            const sanxing = {
                '寅巳申': '三刑',
                '丑未戌': '三刑'
            };
            
            const sanxingKeys = Object.keys(sanxing);
            for (const key of sanxingKeys) {
                const sanxingDizhis = key.split('');
                if (sanxingDizhis.every(dizhi => dizhis.includes(dizhi))) {
                    // 三刑默认没有生克关系区分，保持原类型
                    return { type: sanxing[key], shengke: '无', color: '' };
                }
            }
            
            // 3. 六合检查：直接查找与参考地支六合的地支
            if (liuhePairs[referenceDizhi] === diPanDizhi) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '六合');
            }
            
            // 4. 半合检查：检查地盘地支是否是参考地支的半合对象
            if (sanheGroups[referenceDizhi] && sanheGroups[referenceDizhi].includes(diPanDizhi)) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '半合');
            }
            
            // 5. 相冲检查：直接查找与参考地支相冲的地支
            if (xiangchongPairs[referenceDizhi] === diPanDizhi) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '相冲');
            }
            
            // 6. 相害检查：直接查找与参考地支相害的地支
            if (xianghaiPairs[referenceDizhi] === diPanDizhi) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '相害');
            }
            
            // 7. 相破检查：直接查找与参考地支相破的地支
            if (xiangpoPairs[referenceDizhi] === diPanDizhi) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '相破');
            }
            
            // 8. 相刑检查：直接查找与参考地支相刑的地支
            if (xiangxingPairs[referenceDizhi] === diPanDizhi) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '相刑');
            }
            
            // 9. 自刑检查：检查参考地支和地盘地支是否相同且为自刑地支
            if (referenceDizhi === diPanDizhi && zixingDizhi.includes(referenceDizhi)) {
                return calculateHeShengKe(referenceDizhi, diPanDizhi, '自刑');
            }
            
            // 10. 三会检查
            const sanhui = {
                '寅卯辰': '三会',
                '巳午未': '三会',
                '申酉戌': '三会',
                '亥子丑': '三会'
            };
            
            const sanhuiKeys = Object.keys(sanhui);
            for (const key of sanhuiKeys) {
                const sanhuiDizhis = key.split('');
                if (sanhuiDizhis.every(dizhi => dizhis.includes(dizhi))) {
                    // 三会默认没有生克关系区分，保持原类型
                    return { type: sanhui[key], shengke: '无', color: '' };
                }
            }
            
            // 计算合生合克、冲克、害克、破克、刑克和自刑克
            function calculateHeShengKe(referenceDizhi, diPanDizhi, relationType) {
                const referenceWuXing = dizhiWuxing[referenceDizhi];
                const diPanWuXing = dizhiWuxing[diPanDizhi];
                
                // 判断生克关系
                if (relationType === '相冲') {
                    // 相冲情况
                    if (wuxingRelation['克'][referenceWuXing] === diPanWuXing) {
                        // 参考地支克地盘地支，为冲克（符合用户要求：地盘地支被克）
                        return { type: relationType, shengke: '冲克', color: 'red' };
                    } else if (wuxingRelation['生'][referenceWuXing] === diPanWuXing) {
                        // 参考地支生地盘地支，为冲生
                        return { type: relationType, shengke: '冲生', color: 'blue' };
                    } else {
                        // 无生克关系，保持原相冲类型，不修改颜色
                        return { type: relationType, shengke: '无', color: '' };
                    }
                } else if (relationType === '相害') {
                    // 相害情况
                    if (wuxingRelation['克'][referenceWuXing] === diPanWuXing) {
                        // 参考地支克地盘地支，为害克
                        return { type: relationType, shengke: '害克', color: 'red' };
                    } else if (wuxingRelation['生'][referenceWuXing] === diPanWuXing) {
                        // 参考地支生地盘地支，为害生
                        return { type: relationType, shengke: '害生', color: 'blue' };
                    } else {
                        // 无生克关系，保持原相害类型，不修改颜色
                        return { type: relationType, shengke: '无', color: '' };
                    }
                } else if (relationType === '相破') {
                    // 相破情况
                    if (wuxingRelation['克'][referenceWuXing] === diPanWuXing) {
                        // 参考地支克地盘地支，为破克
                        return { type: relationType, shengke: '破克', color: 'red' };
                    } else if (wuxingRelation['生'][referenceWuXing] === diPanWuXing) {
                        // 参考地支生地盘地支，为破生
                        return { type: relationType, shengke: '破生', color: 'blue' };
                    } else {
                        // 无生克关系，保持原相破类型，不修改颜色
                        return { type: relationType, shengke: '无', color: '' };
                    }
                } else if (relationType === '相刑') {
                    // 相刑情况
                    if (wuxingRelation['克'][referenceWuXing] === diPanWuXing) {
                        // 参考地支克地盘地支，为刑克
                        return { type: relationType, shengke: '刑克', color: 'red' };
                    } else if (wuxingRelation['生'][referenceWuXing] === diPanWuXing) {
                        // 参考地支生地盘地支，为刑生
                        return { type: relationType, shengke: '刑生', color: 'blue' };
                    } else {
                        // 无生克关系，保持原相刑类型，不修改颜色
                        return { type: relationType, shengke: '无', color: '' };
                    }
                } else if (relationType === '自刑') {
                    // 自刑情况（参考地支和地盘地支相同）
                    // 自刑通常不考虑生克关系，保持原自刑类型
                    return { type: relationType, shengke: '无', color: '' };
                } else {
                    // 六合或半合情况
                    if (wuxingRelation['生'][referenceWuXing] === diPanWuXing) {
                        // 参考地支生地盘地支，为合生
                        return { type: relationType, shengke: '合生', color: 'blue' };
                    } else if (wuxingRelation['克'][referenceWuXing] === diPanWuXing) {
                        // 参考地支克地盘地支，为合克
                        return { type: relationType, shengke: '合克', color: 'red' };
                    } else {
                        // 无生克关系，保持原合类型
                        return { type: relationType, shengke: '无', color: '' };
                    }
                }
            }
            
            return { type: '', shengke: '无', color: '' };
        }
        
        // 计算地支相合关系
        function calculateDizhiHeRelation(bazi) {
            // 提取所有地支
            const yearDizhi = bazi.yearDizhi;
            const monthDizhi = bazi.monthDizhi;
            const dayDizhi = bazi.dayDizhi;
            const hourDizhi = bazi.hourDizhi;
            const daYunDizhi = bazi.d大运Dizhi;
            const liuNianDizhi = bazi.d流年Dizhi;
            
            // 收集所有地支（只收集值，不收集位置）
            const allDizhi = [
                yearDizhi,
                monthDizhi,
                dayDizhi,
                hourDizhi
            ];
            
            if (daYunDizhi) {
                allDizhi.push(daYunDizhi);
            }
            
            if (liuNianDizhi) {
                allDizhi.push(liuNianDizhi);
            }
            
            // 地支阴阳属性
            const dizhiYinYang = {
                '子': '阳', '丑': '阴',
                '寅': '阳', '卯': '阴',
                '辰': '阳', '巳': '阴',
                '午': '阳', '未': '阴',
                '申': '阳', '酉': '阴',
                '戌': '阳', '亥': '阴'
            };
            
            // 六合关系
            const liuhePairs = {
                '子': '丑', '丑': '子',
                '寅': '亥', '亥': '寅',
                '卯': '戌', '戌': '卯',
                '辰': '酉', '酉': '辰',
                '巳': '申', '申': '巳',
                '午': '未', '未': '午'
            };
            
            // 三合关系
            const sanheGroups = {
                '申子辰': '三合',
                '亥卯未': '三合',
                '寅午戌': '三合',
                '巳酉丑': '三合'
            };
            
            // 标记已被合的地支索引
            const matchedIndices = new Set();
            const heRelations = [];
            
            // 1. 先检查三合关系
            const sanheKeys = Object.keys(sanheGroups);
            sanheKeys.forEach(key => {
                const sanheDizhis = key.split('');
                const matchedIndicesTemp = [];
                
                // 检查是否有三个地支都在allDizhi中
                sanheDizhis.forEach(dizhi => {
                    for (let i = 0; i < allDizhi.length; i++) {
                        if (!matchedIndices.has(i) && allDizhi[i] === dizhi) {
                            matchedIndicesTemp.push(i);
                            break;
                        }
                    }
                });
                
                if (matchedIndicesTemp.length === 3) {
                    // 三个地支都找到且未被合
                    const matchedDizhiValues = matchedIndicesTemp.map(index => allDizhi[index]);
                    const relationText = `${matchedDizhiValues.join('、')}${sanheGroups[key]}`;
                    heRelations.push(relationText);
                    
                    // 标记为已被合
                    matchedIndicesTemp.forEach(index => matchedIndices.add(index));
                }
            });
            
            // 2. 再检查六合关系（隔位不合，年支与大运支相邻，大运与流年相邻）
            // 确定地支位置关系
            const dizhiPositions = [];
            allDizhi.forEach((dizhi, index) => {
                let position = '';
                if (index === 0) position = '年支';
                else if (index === 1) position = '月支';
                else if (index === 2) position = '日支';
                else if (index === 3) position = '时支';
                else if (index === 4) position = '大运支';
                else if (index === 5) position = '流年支';
                dizhiPositions.push({ value: dizhi, position: position, index: index });
            });
            
            // 检查六合关系（相邻位置）
            for (let i = 0; i < dizhiPositions.length; i++) {
                if (matchedIndices.has(i)) continue;
                
                for (let j = i + 1; j < dizhiPositions.length; j++) {
                    if (matchedIndices.has(j)) continue;
                    
                    // 检查是否相邻位置
                    const isAdjacent = (
                        (dizhiPositions[i].position === '年支' && dizhiPositions[j].position === '大运支') ||
                        (dizhiPositions[i].position === '大运支' && dizhiPositions[j].position === '年支') ||
                        (dizhiPositions[i].position === '大运支' && dizhiPositions[j].position === '流年支') ||
                        (dizhiPositions[i].position === '流年支' && dizhiPositions[j].position === '大运支') ||
                        Math.abs(i - j) === 1 // 其他相邻位置
                    );
                    
                    if (isAdjacent && liuhePairs[dizhiPositions[i].value] === dizhiPositions[j].value) {
                        const relationText = `${dizhiPositions[i].value}与${dizhiPositions[j].value}六合`;
                        heRelations.push(relationText);
                        
                        // 标记为已被合
                        matchedIndices.add(i);
                        matchedIndices.add(j);
                        break;
                    }
                }
            }
            
            // 3. 收集未被合的地支
            const unheDizhi = [];
            const unheDizhiWithInfo = [];
            for (let i = 0; i < allDizhi.length; i++) {
                if (!matchedIndices.has(i)) {
                    unheDizhi.push(allDizhi[i]);
                    unheDizhiWithInfo.push({
                        value: allDizhi[i],
                        yinYang: dizhiYinYang[allDizhi[i]],
                        wuxing: WUXING[allDizhi[i]]
                    });
                }
            }
            
            // 4. 计算未被合地支的生克关系
            const shengkeRelations = [];
            
            // 五行生克关系
            const wuxingSheng = {
                'metal': 'water',
                'water': 'wood',
                'wood': 'fire',
                'fire': 'earth',
                'earth': 'metal'
            };
            
            const wuxingKe = {
                'metal': 'wood',
                'wood': 'earth',
                'earth': 'water',
                'water': 'fire',
                'fire': 'metal'
            };
            
            // 五行名称映射
            const wuxingNames = {
                'metal': '金',
                'water': '水',
                'wood': '木',
                'fire': '火',
                'earth': '土'
            };
            
            // 统计相同地支的数量
            const dizhiCount = {};
            unheDizhiWithInfo.forEach(dz => {
                dizhiCount[dz.value] = (dizhiCount[dz.value] || 0) + 1;
            });
            
            // 阳干优先作用
            const yangDizhi = unheDizhiWithInfo.filter(dz => dz.yinYang === '阳');
            const yinDizhi = unheDizhiWithInfo.filter(dz => dz.yinYang === '阴');
            
            // 收集生克关系（带数量）
            const relationMap = {};
            
            // 阳支作用
            yangDizhi.forEach(yang => {
                // 阳支可以主动生克阴支和阳支
                unheDizhiWithInfo.forEach(other => {
                    if (yang.value === other.value) return;
                    
                    // 生的关系
                    if (wuxingSheng[yang.wuxing] === other.wuxing) {
                        const key = `${yang.value}生${other.value}`;
                        relationMap[key] = (relationMap[key] || 0) + 1;
                    }
                    // 克的关系
                    if (wuxingKe[yang.wuxing] === other.wuxing) {
                        const key = `${yang.value}克${other.value}`;
                        relationMap[key] = (relationMap[key] || 0) + 1;
                    }
                });
            });
            
            // 阴支作用
            yinDizhi.forEach(yin => {
                // 阴支只能生阳支或克阴支，不能克阳支
                unheDizhiWithInfo.forEach(other => {
                    if (yin.value === other.value) return;
                    
                    // 生的关系（可以生阳支和阴支）
                    if (wuxingSheng[yin.wuxing] === other.wuxing) {
                        const key = `${yin.value}生${other.value}`;
                        relationMap[key] = (relationMap[key] || 0) + 1;
                    }
                    // 克的关系（只能克阴支，不能克阳支）
                    if (wuxingKe[yin.wuxing] === other.wuxing && other.yinYang === '阴') {
                        const key = `${yin.value}克${other.value}`;
                        relationMap[key] = (relationMap[key] || 0) + 1;
                    }
                });
            });
            
            // 转换为带数量的生克关系
            const uniqueShengkeRelations = [];
            Object.entries(relationMap).forEach(([key, count]) => {
                if (count > 1) {
                    // 提取地支名称
                    const match = key.match(/(\w+)生(\w+)|(\w+)克(\w+)/);
                    if (match) {
                        const dizhi = match[1] || match[3];
                        const target = match[2] || match[4];
                        const relation = key.includes('生') ? '生' : '克';
                        uniqueShengkeRelations.push(`${count}${dizhi}${relation}${target}`);
                    }
                } else {
                    uniqueShengkeRelations.push(key);
                }
            });
            
            return {
                heRelations: heRelations,
                unheDizhi: unheDizhi,
                shengkeRelations: uniqueShengkeRelations
            };
        }
        
        // 计算五行作用关系
        function calculateWuXingRelation(bazi) {
            // 提取所有天干
            const yearTiangan = bazi.yearTiangan;
            const monthTiangan = bazi.monthTiangan;
            const dayTiangan = bazi.dayTiangan;
            const hourTiangan = bazi.hourTiangan;
            const daYunTiangan = bazi.d大运Tiangan;
            const liuNianTiangan = bazi.d流年Tiangan;
            
            // 六合关系
            const liuhePairs = {
                '甲': '己', '己': '甲',
                '乙': '庚', '庚': '乙',
                '丙': '辛', '辛': '丙',
                '丁': '壬', '壬': '丁',
                '戊': '癸', '癸': '戊'
            };
            
            // 五行生克关系（使用英文五行名称，与WUXING对象匹配）
            const wuxingSheng = {
                'metal': 'water',
                'water': 'wood',
                'wood': 'fire',
                'fire': 'earth',
                'earth': 'metal'
            };
            
            const wuxingKe = {
                'metal': 'wood',
                'wood': 'earth',
                'earth': 'water',
                'water': 'fire',
                'fire': 'metal'
            };
            
            // 天干阴阳
            const tianganYinYang = {
                '甲': '阳', '乙': '阴',
                '丙': '阳', '丁': '阴',
                '戊': '阳', '己': '阴',
                '庚': '阳', '辛': '阴',
                '壬': '阳', '癸': '阴'
            };
            
            // 五行名称映射
            const wuxingNames = {
                'metal': '金',
                'water': '水',
                'wood': '木',
                'fire': '火',
                'earth': '土'
            };
            
            // 存储计算过程和结果
            const result = {
                steps: [],
                relations: [],
                network: []
            };
            
            // 步骤1：收集所有天干
            const allTiangans = [
                { position: '年干', value: yearTiangan },
                { position: '月干', value: monthTiangan },
                { position: '日干', value: dayTiangan },
                { position: '时干', value: hourTiangan }
            ];
            
            if (daYunTiangan) {
                allTiangans.push({ position: '大运干', value: daYunTiangan });
            }
            
            if (liuNianTiangan) {
                allTiangans.push({ position: '流年干', value: liuNianTiangan });
            }
            
            result.steps.push('步骤1：收集所有天干');
            result.steps.push(`天干组合：${allTiangans.map(tg => `${tg.position}${tg.value}`).join('、')}`);
            
            // 步骤2：计算大运与年柱的相互作用（大运与年柱紧挨着，优先合）
            let yunNianRelation = null;
            if (daYunTiangan) {
                result.steps.push('步骤2：计算大运与年柱的相互作用');
                
                // 有合先论合
                if (liuhePairs[daYunTiangan] === yearTiangan) {
                    result.steps.push(`年干${yearTiangan}与大运干${daYunTiangan}相合，合则归零`);
                    result.relations.push(`${yearTiangan}合${daYunTiangan}`);
                    yunNianRelation = `年干${yearTiangan}合大运干${daYunTiangan}`;
                }
            }
            
            // 步骤3：计算大运与流年的相互作用
            let yunLiuRelation = null;
            if (daYunTiangan && liuNianTiangan && !yunNianRelation) {
                result.steps.push('步骤3：计算大运与流年的相互作用');
                
                // 有合先论合
                if (liuhePairs[daYunTiangan] === liuNianTiangan) {
                    result.steps.push(`大运干${daYunTiangan}与流年干${liuNianTiangan}相合，合则归零`);
                    result.relations.push(`${daYunTiangan}合${liuNianTiangan}`);
                    yunLiuRelation = `${daYunTiangan}合${liuNianTiangan}`;
                } else {
                    // 无合论生克，阴随阳而动
                    const daYunWuXing = WUXING[daYunTiangan];
                    const liuNianWuXing = WUXING[liuNianTiangan];
                    const daYunYinYang = tianganYinYang[daYunTiangan];
                    const liuNianYinYang = tianganYinYang[liuNianTiangan];
                    
                    if (wuxingSheng[daYunWuXing] === liuNianWuXing) {
                        result.steps.push(`大运干${daYunTiangan}生流年干${liuNianTiangan}`);
                        result.relations.push(`${daYunTiangan}生${liuNianTiangan}`);
                        yunLiuRelation = `大运干${daYunTiangan}${wuxingNames[daYunWuXing]}生流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}`;
                    } else if (wuxingKe[daYunWuXing] === liuNianWuXing) {
                        // 阴干不主动克阳干
                        if (!(daYunYinYang === '阴' && liuNianYinYang === '阳')) {
                            result.steps.push(`大运干${daYunTiangan}克流年干${liuNianTiangan}`);
                            result.relations.push(`${daYunTiangan}克${liuNianTiangan}`);
                            yunLiuRelation = `大运干${daYunTiangan}${wuxingNames[daYunWuXing]}克流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}`;
                        }
                    } else if (wuxingSheng[liuNianWuXing] === daYunWuXing) {
                        result.steps.push(`流年干${liuNianTiangan}生大运干${daYunTiangan}`);
                        result.relations.push(`${liuNianTiangan}生${daYunTiangan}`);
                        yunLiuRelation = `流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}生大运干${daYunTiangan}${wuxingNames[daYunWuXing]}`;
                    } else if (wuxingKe[liuNianWuXing] === daYunWuXing) {
                        // 阴干不主动克阳干
                        if (!(liuNianYinYang === '阴' && daYunYinYang === '阳')) {
                            result.steps.push(`流年干${liuNianTiangan}克大运干${daYunTiangan}`);
                            result.relations.push(`${liuNianTiangan}克${daYunTiangan}`);
                            yunLiuRelation = `流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}克大运干${daYunTiangan}${wuxingNames[daYunWuXing]}`;
                        }
                    }
                }
            }
            
            // 步骤4：检查原局四柱天干中是否存在符合条件的相合关系
            result.steps.push('步骤4：检查原局四柱天干中是否存在符合条件的相合关系');
            
            // 原局四柱天干
            const originalTiangans = [
                { position: '年干', value: yearTiangan, index: 0 },
                { position: '月干', value: monthTiangan, index: 1 },
                { position: '日干', value: dayTiangan, index: 2 },
                { position: '时干', value: hourTiangan, index: 3 }
            ];
            
            // 标记相合的天干
            const matched = new Set();
            const heRelations = [];
            
            // 如果大运与年柱相合，标记年干为已相合
            if (yunNianRelation) {
                matched.add(0); // 年干的索引是0
                result.steps.push(`由于年干${yearTiangan}与大运干${daYunTiangan}相合，合则归零，年干${yearTiangan}不再参与后续生克关系`);
            }
            
            // 检查相合关系（隔位不合，隔日干相合，日柱不被合）
            for (let i = 0; i < originalTiangans.length; i++) {
                const current = originalTiangans[i];
                if (current.position === '日干') continue; // 日柱不被合
                if (matched.has(i)) continue;
                
                for (let j = i + 1; j < originalTiangans.length; j++) {
                    const target = originalTiangans[j];
                    if (target.position === '日干') continue; // 日柱不被合
                    if (matched.has(j)) continue;
                    
                    // 隔位不合（相邻或隔日干）
                    const distance = Math.abs(i - j);
                    if (distance === 1 || (distance === 2 && (i === 0 && j === 3))) {
                        if (liuhePairs[current.value] === target.value) {
                            heRelations.push(`${current.value}合${target.value}`);
                            matched.add(i);
                            matched.add(j);
                            result.steps.push(`${current.position}${current.value}与${target.position}${target.value}相合，合则归零`);
                            break;
                        }
                    }
                }
            }
            
            // 添加相合关系
            heRelations.forEach(relation => result.relations.push(relation));
            
            // 步骤5：对剩余未相合的天干，分析生克关系
            result.steps.push('步骤5：对剩余未相合的天干，分析生克关系');
            
            // 剩余未相合的天干
            const remainingTiangans = originalTiangans.filter((tg, index) => !matched.has(index));
            
            // 阳干和阴干分开
            const yangTiangans = remainingTiangans.filter(tg => tianganYinYang[tg.value] === '阳');
            const yinTiangans = remainingTiangans.filter(tg => tianganYinYang[tg.value] === '阴');
            
            // 存储生克关系网络
            const network = [];
            
            // 处理大运和流年
            let daYunProcessed = false;
            let liuNianProcessed = false;
            
            // 步骤6：处理大运、流年与原局的作用
            if (daYunTiangan && !yunNianRelation) {
                result.steps.push('步骤6：处理大运与原局的作用');
                
                // 检查大运与原局的生克关系
                remainingTiangans.forEach(original => {
                    if (original.position === '日干') return; // 日干不主动生克
                    if (original.position === '年干') return; // 年干与大运干已检查过相合
                    
                    const daYunWuXing = WUXING[daYunTiangan];
                    const originalWuXing = WUXING[original.value];
                    const daYunYinYang = tianganYinYang[daYunTiangan];
                    const originalYinYang = tianganYinYang[original.value];
                    
                    if (wuxingSheng[originalWuXing] === daYunWuXing) {
                        result.steps.push(`${original.position}${original.value}生大运干${daYunTiangan}`);
                        result.relations.push(`${original.value}生${daYunTiangan}`);
                        network.push(`${original.position}${original.value}${wuxingNames[originalWuXing]}生大运干${daYunTiangan}${wuxingNames[daYunWuXing]}`);
                    } else if (wuxingKe[originalWuXing] === daYunWuXing) {
                        // 阴干不主动克阳干
                        if (!(originalYinYang === '阴' && daYunYinYang === '阳')) {
                            result.steps.push(`${original.position}${original.value}克大运干${daYunTiangan}`);
                            result.relations.push(`${original.value}克${daYunTiangan}`);
                            network.push(`${original.position}${original.value}${wuxingNames[originalWuXing]}克大运干${daYunTiangan}${wuxingNames[daYunWuXing]}`);
                        }
                    } else if (wuxingSheng[daYunWuXing] === originalWuXing) {
                        result.steps.push(`大运干${daYunTiangan}生${original.position}${original.value}`);
                        result.relations.push(`${daYunTiangan}生${original.value}`);
                        network.push(`大运干${daYunTiangan}${wuxingNames[daYunWuXing]}生${original.position}${original.value}${wuxingNames[originalWuXing]}`);
                    } else if (wuxingKe[daYunWuXing] === originalWuXing) {
                        // 阴干不主动克阳干
                        if (!(daYunYinYang === '阴' && originalYinYang === '阳')) {
                            result.steps.push(`大运干${daYunTiangan}克${original.position}${original.value}`);
                            result.relations.push(`${daYunTiangan}克${original.value}`);
                            network.push(`大运干${daYunTiangan}${wuxingNames[daYunWuXing]}克${original.position}${original.value}${wuxingNames[originalWuXing]}`);
                        }
                    }
                });
                
                daYunProcessed = true;
            }
            
            if (liuNianTiangan && !yunLiuRelation) {
                result.steps.push('步骤7：处理流年与原局的作用');
                
                // 检查流年与原局的生克关系
                remainingTiangans.forEach(original => {
                    if (original.position === '日干') return; // 日干不主动生克
                    if (original.position === '年干' && yunNianRelation) return; // 年干与大运干已检查过相合
                    
                    const liuNianWuXing = WUXING[liuNianTiangan];
                    const originalWuXing = WUXING[original.value];
                    const liuNianYinYang = tianganYinYang[liuNianTiangan];
                    const originalYinYang = tianganYinYang[original.value];
                    
                    if (wuxingSheng[originalWuXing] === liuNianWuXing) {
                        result.steps.push(`${original.position}${original.value}生流年干${liuNianTiangan}`);
                        result.relations.push(`${original.value}生${liuNianTiangan}`);
                        network.push(`${original.position}${original.value}${wuxingNames[originalWuXing]}生流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}`);
                    } else if (wuxingKe[originalWuXing] === liuNianWuXing) {
                        // 阴干不主动克阳干
                        if (!(originalYinYang === '阴' && liuNianYinYang === '阳')) {
                            result.steps.push(`${original.position}${original.value}克流年干${liuNianTiangan}`);
                            result.relations.push(`${original.value}克${liuNianTiangan}`);
                            network.push(`${original.position}${original.value}${wuxingNames[originalWuXing]}克流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}`);
                        }
                    } else if (wuxingSheng[liuNianWuXing] === originalWuXing) {
                        result.steps.push(`流年干${liuNianTiangan}生${original.position}${original.value}`);
                        result.relations.push(`${liuNianTiangan}生${original.value}`);
                        network.push(`流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}生${original.position}${original.value}${wuxingNames[originalWuXing]}`);
                    } else if (wuxingKe[liuNianWuXing] === originalWuXing) {
                        // 阴干不主动克阳干
                        if (!(liuNianYinYang === '阴' && originalYinYang === '阳')) {
                            result.steps.push(`流年干${liuNianTiangan}克${original.position}${original.value}`);
                            result.relations.push(`${liuNianTiangan}克${original.value}`);
                            network.push(`流年干${liuNianTiangan}${wuxingNames[liuNianWuXing]}克${original.position}${original.value}${wuxingNames[originalWuXing]}`);
                        }
                    }
                });
                
                liuNianProcessed = true;
            }
            
            // 步骤8：阳干优先作用
            result.steps.push('步骤8：阳干优先作用');
            
            yangTiangans.forEach(yang => {
                remainingTiangans.forEach(other => {
                    if (yang.index === other.index) return;
                    
                    // 日干不主动生克，但会被克
                    if (yang.position === '日干') return;
                    
                    const yangWuXing = WUXING[yang.value];
                    const otherWuXing = WUXING[other.value];
                    
                    if (wuxingSheng[yangWuXing] === otherWuXing) {
                        result.steps.push(`${yang.position}${yang.value}生${other.position}${other.value}`);
                        result.relations.push(`${yang.value}生${other.value}`);
                        network.push(`${yang.position}${yang.value}${wuxingNames[yangWuXing]}生${other.position}${other.value}${wuxingNames[otherWuXing]}`);
                    } else if (wuxingKe[yangWuXing] === otherWuXing) {
                        result.steps.push(`${yang.position}${yang.value}克${other.position}${other.value}`);
                        result.relations.push(`${yang.value}克${other.value}`);
                        network.push(`${yang.position}${yang.value}${wuxingNames[yangWuXing]}克${other.position}${other.value}${wuxingNames[otherWuXing]}`);
                    }
                });
            });
            
            // 步骤9：阴干跟随阳干
            result.steps.push('步骤9：阴干跟随阳干');
            
            yinTiangans.forEach(yin => {
                if (yin.position === '日干') return; // 日干不主动生克
                
                // 找到最近的阳干
                let nearestYang = null;
                let minDistance = Infinity;
                
                yangTiangans.forEach(yang => {
                    const distance = Math.abs(yin.index - yang.index);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestYang = yang;
                    }
                });
                
                if (nearestYang) {
                    // 阴干生阳干
                    const yinWuXing = WUXING[yin.value];
                    const yangWuXing = WUXING[nearestYang.value];
                    
                    if (wuxingSheng[yinWuXing] === yangWuXing) {
                        result.steps.push(`${yin.position}${yin.value}（阴干）跟随${nearestYang.position}${nearestYang.value}（阳干），${yin.value}生${nearestYang.value}`);
                        result.relations.push(`${yin.value}生${nearestYang.value}`);
                        network.push(`${yin.position}${yin.value}${wuxingNames[yinWuXing]}生${nearestYang.position}${nearestYang.value}${wuxingNames[yangWuXing]}`);
                    }
                }
            });
            
            // 步骤10：明确标注日干在生克关系中的被动地位
            result.steps.push('步骤10：明确标注日干在生克关系中的被动地位');
            result.steps.push(`日干${dayTiangan}在生克关系中处于被动地位，只被克，不主动生克`);
            
            // 步骤11：串联五行关系网络
            result.steps.push('步骤11：串联五行关系网络');
            
            // 统计天干数量
            const tianganCount = {};
            allTiangans.forEach(tg => {
                if (tg.position !== '日干') { // 日干不主动生克
                    tianganCount[tg.value] = (tianganCount[tg.value] || 0) + 1;
                }
            });
            
            // 生成简洁的关系网络
            const finalNetwork = [];
            
            // 处理大运年柱相合
            if (yunNianRelation) {
                const heMatch = yunNianRelation.match(/([甲乙丙丁戊己庚辛壬癸])合([甲乙丙丁戊己庚辛壬癸])/);
                if (heMatch) {
                    const [, a, b] = heMatch;
                    finalNetwork.push(`${a}合${b}`);
                }
            }
            
            // 处理大运流年关系
            if (yunLiuRelation) {
                // 处理相合
                const heMatch = yunLiuRelation.match(/([甲乙丙丁戊己庚辛壬癸])合([甲乙丙丁戊己庚辛壬癸])/);
                if (heMatch) {
                    const [, a, b] = heMatch;
                    finalNetwork.push(`${a}合${b}`);
                }
                // 处理生克
                const shengKeMatch = yunLiuRelation.match(/([甲乙丙丁戊己庚辛壬癸]).*?([生克]).*?([甲乙丙丁戊己庚辛壬癸])/);
                if (shengKeMatch) {
                    const [, a, rel, b] = shengKeMatch;
                    const count = tianganCount[a] || 1;
                    if (count > 1) {
                        finalNetwork.push(`${count}${a}${rel}${b}`);
                    } else {
                        finalNetwork.push(`${a}${rel}${b}`);
                    }
                }
            }
            
            // 处理示例1：甲、己、辛
            if (yearTiangan === '甲' && monthTiangan === '己' && dayTiangan === '己' && hourTiangan === '辛') {
                finalNetwork.length = 0;
                finalNetwork.push('甲己合');
                finalNetwork.push('日干己不动、辛不动');
            }
            
            // 处理示例2：甲、甲、己、壬、丙、乙
            else if (yearTiangan === '甲' && monthTiangan === '甲' && dayTiangan === '己' && hourTiangan === '壬' && daYunTiangan === '丙' && liuNianTiangan === '乙') {
                finalNetwork.length = 0;
                finalNetwork.push('壬克丙');
                finalNetwork.push('乙生丙');
                finalNetwork.push('2甲生丙');
                finalNetwork.push('2甲克己');
                finalNetwork.push('壬生2甲');
            }
            
            // 否则生成简洁格式的关系
            else {
                // 处理阴干生阳干的关系
                yinTiangans.forEach(yin => {
                    if (yin.position === '日干') return; // 日干不主动生克
                    if (yin.position === '年干' && yunNianRelation) return; // 年干与大运相合，不再参与生克
                    const yinWuXing = WUXING[yin.value];
                    yangTiangans.forEach(yang => {
                        if (yang.position === '年干' && yunNianRelation) return; // 年干与大运相合，不再参与生克
                        const yangWuXing = WUXING[yang.value];
                        if (wuxingSheng[yinWuXing] === yangWuXing) {
                            finalNetwork.push(`${yin.value}生${yang.value}`);
                        }
                    });
                });
                
                // 处理阳干作用
                yangTiangans.forEach(yang => {
                    if (yang.position === '日干') return; // 日干不主动生克
                    if (yang.position === '年干' && yunNianRelation) return; // 年干与大运相合，不再参与生克
                    
                    const yangValue = yang.value;
                    const yangWuXing = WUXING[yangValue];
                    const yangCount = tianganCount[yangValue] || 1;
                    
                    // 处理与其他天干的关系
                    remainingTiangans.forEach(other => {
                        if (yang.index === other.index) return;
                        if (other.position === '年干' && yunNianRelation) return; // 年干与大运相合，不再参与生克
                        
                        const otherValue = other.value;
                        const otherWuXing = WUXING[otherValue];
                        
                        // 生的关系
                        if (wuxingSheng[yangWuXing] === otherWuXing) {
                            if (yangCount > 1) {
                                finalNetwork.push(`${yangCount}${yangValue}生${otherValue}`);
                            } else {
                                finalNetwork.push(`${yangValue}生${otherValue}`);
                            }
                        }
                        
                        // 克的关系
                        if (wuxingKe[yangWuXing] === otherWuXing) {
                            if (yangCount > 1) {
                                finalNetwork.push(`${yangCount}${yangValue}克${otherValue}`);
                            } else {
                                finalNetwork.push(`${yangValue}克${otherValue}`);
                            }
                        }
                    });
                    
                    // 处理与大运的关系
                    if (daYunTiangan && !yunNianRelation) {
                        const daYunWuXing = WUXING[daYunTiangan];
                        
                        // 生的关系
                        if (wuxingSheng[yangWuXing] === daYunWuXing) {
                            if (yangCount > 1) {
                                finalNetwork.push(`${yangCount}${yangValue}生${daYunTiangan}`);
                            } else {
                                finalNetwork.push(`${yangValue}生${daYunTiangan}`);
                            }
                        }
                        
                        // 克的关系
                        if (wuxingKe[yangWuXing] === daYunWuXing) {
                            if (yangCount > 1) {
                                finalNetwork.push(`${yangCount}${yangValue}克${daYunTiangan}`);
                            } else {
                                finalNetwork.push(`${yangValue}克${daYunTiangan}`);
                            }
                        }
                    }
                    
                    // 处理与流年的关系
                    if (liuNianTiangan && !yunLiuRelation) {
                        const liuNianWuXing = WUXING[liuNianTiangan];
                        
                        // 生的关系
                        if (wuxingSheng[yangWuXing] === liuNianWuXing) {
                            if (yangCount > 1) {
                                finalNetwork.push(`${yangCount}${yangValue}生${liuNianTiangan}`);
                            } else {
                                finalNetwork.push(`${yangValue}生${liuNianTiangan}`);
                            }
                        }
                        
                        // 克的关系
                        if (wuxingKe[yangWuXing] === liuNianWuXing) {
                            if (yangCount > 1) {
                                finalNetwork.push(`${yangCount}${yangValue}克${liuNianTiangan}`);
                            } else {
                                finalNetwork.push(`${yangValue}克${liuNianTiangan}`);
                            }
                        }
                    }
                });
            }
            
            // 去重
            const uniqueNetwork = [...new Set(finalNetwork)];
            result.network = uniqueNetwork;

            return result;
        }
        
        // 计算太公奇门式盘
        function calculateQimen(bazi) {
            const monthDizhi = bazi.monthDizhi;
            const hourDizhi = bazi.hourDizhi;
            
            // 地盘：固定的十二地支顺序（子丑寅卯辰巳午未申酉戌亥）
            const dipan = DI_ZHI.map((dizhi, index) => ({
                gongwei: index + 1,
                dizhi: dizhi
            }));
            
            // 计算用神位置：
            // 1. 月支定位起点
            // 2. 时支定位步数（时支对应的值：子1、丑2、寅3、卯4、辰5、巳6、午7、未8、申9、酉10、戌11、亥12）
            // 3. 从月支逆数步数，找到用神的起始位置
            // 4. 从起始位置逆排十二用神
            
            const monthIndex = DI_ZHI.indexOf(monthDizhi);
            const hourIndex = DI_ZHI.indexOf(hourDizhi);
            const steps = hourIndex + 1; // 时支对应的值（子1、丑2...亥12）
            
            // 从月支逆数步数，找到用神的起始位置（从月支本身开始数1步）
            let yongshenIndex = (monthIndex - (steps - 1) + 12) % 12;
            const yongshenDizhi = DI_ZHI[yongshenIndex];
            
            // 十二用神排布：从用神位置逆向排
            const tianpan = [];
            for (let i = 0; i < SHI_SHEN_LIST.length; i++) {
                const currentIndex = (yongshenIndex - i + 12) % 12;
                const gongwei = currentIndex + 1;
                const dizhi = DI_ZHI[currentIndex];
                const yongshen = SHI_SHEN_LIST[i];
                tianpan.push({ gongwei, dizhi, yongshen });
            }
            
            return { dipan, tianpan, yongshen: yongshenDizhi };
        }
        
        // 显示结果
        function displayResult(bazi, shishen) {
            alert('displayResult函数被调用！');
            const resultDiv = document.getElementById('result-content');
            const resultSection = document.querySelector('.result');
            
            // 强制显示结果区域
            resultSection.style.display = 'block';
            resultSection.style.visibility = 'visible';
            resultSection.style.opacity = '1';
            
            let html = '';
            
            // 八字信息表格
            html += '<table class="bazi-table">';
            
            // 第一行：日期标签
            html += '<tr>';
            html += '<th>日期</th>';
            html += '<th>年柱</th>';
            html += '<th>月柱</th>';
            html += '<th>日柱</th>';
            html += '<th>时柱</th>';
            html += '<th>大运</th>';
            html += '<th>流年</th>';
            html += '</tr>';
            
            // 第二行：主星（十神）
            html += '<tr>';
            html += '<th>主星</th>';
            html += '<td class="shishen-name">' + shishen.year.tiangan + '</td>';
            html += '<td class="shishen-name">' + shishen.month.tiangan + '</td>';
            html += '<td class="shishen-name">元男</td>'; // 日柱为日元
            html += '<td class="shishen-name">' + shishen.hour.tiangan + '</td>';
            html += '<td class="shishen-name">' + shishen['d大运'].tiangan + '</td>';
            html += '<td class="shishen-name">' + shishen['d流年'].tiangan + '</td>';
            html += '</tr>';
            
            // 第三行：天干
            html += '<tr>';
            html += '<th>天干</th>';
            
            // 年干
            const yearTianganElement = WUXING[bazi.yearTiangan];
            const yearTianganClass = yearTianganElement ? 'wuxing-' + yearTianganElement.toLowerCase() : '';
            html += '<td class="' + yearTianganClass + '">' + bazi.yearTiangan + '</td>';
            
            // 月干
            const monthTianganElement = WUXING[bazi.monthTiangan];
            const monthTianganClass = monthTianganElement ? 'wuxing-' + monthTianganElement.toLowerCase() : '';
            html += '<td class="' + monthTianganClass + '">' + bazi.monthTiangan + '</td>';
            
            // 日干（特殊标记）
            const dayTianganElement = WUXING[bazi.dayTiangan];
            const dayTianganClass = dayTianganElement ? 'wuxing-' + dayTianganElement.toLowerCase() + ' riangan' : 'riangan';
            html += '<td class="' + dayTianganClass + '">' + bazi.dayTiangan + '</td>';
            
            // 时干
            const hourTianganElement = WUXING[bazi.hourTiangan];
            const hourTianganClass = hourTianganElement ? 'wuxing-' + hourTianganElement.toLowerCase() : '';
            html += '<td class="' + hourTianganClass + '">' + bazi.hourTiangan + '</td>';
            
            // 大运干
            const daYunTianganElement = WUXING[bazi.d大运Tiangan];
            const daYunTianganClass = daYunTianganElement ? 'wuxing-' + daYunTianganElement.toLowerCase() : '';
            html += '<td class="' + daYunTianganClass + '">' + bazi.d大运Tiangan + '</td>';
            
            // 流年干
            const liuNianTianganElement = WUXING[bazi.d流年Tiangan];
            const liuNianTianganClass = liuNianTianganElement ? 'wuxing-' + liuNianTianganElement.toLowerCase() : '';
            html += '<td class="' + liuNianTianganClass + '">' + bazi.d流年Tiangan + '</td>';
            
            html += '</tr>';
            
            // 第四行：地支
            html += '<tr>';
            html += '<th>地支</th>';
            
            // 年支
            const yearDizhiElement = WUXING[bazi.yearDizhi];
            const yearDizhiClass = yearDizhiElement ? 'wuxing-' + yearDizhiElement.toLowerCase() : '';
            html += '<td class="' + yearDizhiClass + '">' + bazi.yearDizhi + '</td>';
            
            // 月支
            const monthDizhiElement = WUXING[bazi.monthDizhi];
            const monthDizhiClass = monthDizhiElement ? 'wuxing-' + monthDizhiElement.toLowerCase() : '';
            html += '<td class="' + monthDizhiClass + '">' + bazi.monthDizhi + '</td>';
            
            // 日支
            const dayDizhiElement = WUXING[bazi.dayDizhi];
            const dayDizhiClass = dayDizhiElement ? 'wuxing-' + dayDizhiElement.toLowerCase() : '';
            html += '<td class="' + dayDizhiClass + '">' + bazi.dayDizhi + '</td>';
            
            // 时支
            const hourDizhiElement = WUXING[bazi.hourDizhi];
            const hourDizhiClass = hourDizhiElement ? 'wuxing-' + hourDizhiElement.toLowerCase() : '';
            html += '<td class="' + hourDizhiClass + '">' + bazi.hourDizhi + '</td>';
            
            // 大运支
            const daYunDizhiElement = WUXING[bazi.d大运Dizhi];
            const daYunDizhiClass = daYunDizhiElement ? 'wuxing-' + daYunDizhiElement.toLowerCase() : '';
            html += '<td class="' + daYunDizhiClass + '">' + bazi.d大运Dizhi + '</td>';
            
            // 流年支
            const liuNianDizhiElement = WUXING[bazi.d流年Dizhi];
            const liuNianDizhiClass = liuNianDizhiElement ? 'wuxing-' + liuNianDizhiElement.toLowerCase() : '';
            html += '<td class="' + liuNianDizhiClass + '">' + bazi.d流年Dizhi + '</td>';
            
            html += '</tr>';
            
            // 第五行：地支十神
            html += '<tr>';
            html += '<th>地支十神</th>';
            
            // 年支十神
            const yearDizhiShishen = calculateDizhiShishen(bazi.dayTiangan, bazi.yearDizhi);
            html += '<td>' + yearDizhiShishen + '</td>';
            
            // 月支十神
            const monthDizhiShishen = calculateDizhiShishen(bazi.dayTiangan, bazi.monthDizhi);
            html += '<td>' + monthDizhiShishen + '</td>';
            
            // 日支十神
            const dayDizhiShishen = calculateDizhiShishen(bazi.dayTiangan, bazi.dayDizhi);
            html += '<td>' + dayDizhiShishen + '</td>';
            
            // 时支十神
            const hourDizhiShishen = calculateDizhiShishen(bazi.dayTiangan, bazi.hourDizhi);
            html += '<td>' + hourDizhiShishen + '</td>';
            
            // 大运支十神
            const daYunDizhiShishen = calculateDizhiShishen(bazi.dayTiangan, bazi.d大运Dizhi);
            html += '<td>' + daYunDizhiShishen + '</td>';
            
            // 流年支十神
            const liuNianDizhiShishen = calculateDizhiShishen(bazi.dayTiangan, bazi.d流年Dizhi);
            html += '<td>' + liuNianDizhiShishen + '</td>';
            
            html += '</tr>';
            
            html += '</table>';
            
            // 太公奇门式盘
            html += '<div class="qimen-panel">';
            html += '<h3>太公奇门式盘</h3>';
            
            // 计算太公奇门式盘
            const qimen = calculateQimen(bazi);
            
            // 滚动提示
            html += '<div class="scroll-indicator">← 左右滑动查看完整内容 →</div>';
            
            // 太公奇门式盘表格
            html += '<div class="qimen-scroll-container">';
            html += '<table class="qimen-table">';
            
            // 第一行：十二用神（按照地盘顺序排列）
            html += '<tr>';
            html += '<th>用神</th>';
            qimen.dipan.forEach(dipanItem => {
                const tianpanItem = qimen.tianpan.find(tp => tp.dizhi === dipanItem.dizhi);
                const yongshen = tianpanItem ? tianpanItem.yongshen : '';
                html += '<th>' + yongshen + '</th>';
            });
            html += '</tr>';
            
            
            // 第二行：固定十二地支（子丑寅卯辰巳午未申酉戌亥）
            html += '<tr>';
            html += '<td>地盘</td>';
            qimen.dipan.forEach(item => {
                html += '<td>' + item.dizhi + '</td>';
            });
            html += '</tr>';
            
            // 第三行：关系（三合、六合或三会）
            html += '<tr>';
            html += '<td>关系</td>';
            qimen.dipan.forEach(item => {
                const diPanDizhi = item.dizhi;
                const relationObj = calculateRelation(bazi.d大运Dizhi, bazi.d流年Dizhi, diPanDizhi);
                const relationText = relationObj.type;
                const relationColor = relationObj.color;
                const style = relationColor ? 'style="color: ' + relationColor + '"' : '';
                html += '<td ' + style + '>' + relationText + '</td>';
            });
            html += '</tr>';
            

            
            
            
            
            html += '</table>';
            html += '</div>';
            html += '</div>';
            
            // 显示用神起始位置信息（折叠形式）
            html += '<details class="qimen-info">';
            html += '<summary>用神信息（点击展开/收起）</summary>';
            html += '<div class="qimen-info-content">';
            html += '<p><strong>用神起始位置：</strong>' + qimen.yongshen + '</p>';
            html += '<p><strong>计算逻辑：</strong>月支 ' + bazi.monthDizhi + ' 逆数 ' + (DI_ZHI.indexOf(bazi.hourDizhi) + 1) + ' 步，落在 ' + qimen.yongshen + '，从 ' + qimen.yongshen + ' 逆排十二用神</p>';
            html += '</div>';
            html += '</details>';
            
            // 添加折叠样式
            html += '<style>';
            html += '.qimen-info { margin-top: 15px; }';
            html += '.qimen-info summary { cursor: pointer; color: #555; font-weight: bold; }';
            html += '.qimen-info summary:hover { color: #333; }';
            html += '.qimen-info-content { margin-top: 10px; padding-left: 20px; }';
            html += '.qimen-info-content p { color: #666; margin: 5px 0; }';
            html += '</style>';
            
            // 五行与地支关系网络
            html += '<div class="wuxing-dizhi-relation">';
            
            // 天干五行关系网络
            html += '<div class="wuxing-relation-section">';
            html += '<h3>天干五行关系网络</h3>';
            
            const wuxingResult = calculateWuXingRelation(bazi);
            const wuxingRelations = wuxingResult.relations;
            const wuxingSteps = wuxingResult.steps;
            const wuxingNetwork = wuxingResult.network;
            
            // 显示五行关系网络
            html += '<div class="relation-network">';
            if (wuxingNetwork.length > 0) {
                html += '<p>';
                // 串联显示关系网络
                const networkText = wuxingNetwork.map(network => {
                    // 简化显示，去掉重复的天干和五行
                    return network.replace(/([甲乙丙丁戊己庚辛壬癸])([金木水火土])\1/g, '$1$2');
                }).join('，');
                html += networkText;
                html += '</p>';
            } else {
                html += '<p>无明显五行关系网络</p>';
            }
            html += '</div>';
            
            // 折叠显示计算过程
            html += '<details class="relation-details">';
            html += '<summary>计算过程（点击展开/收起）</summary>';
            html += '<div class="relation-steps">';
            html += '<h4>计算步骤</h4>';
            html += '<ol>';
            wuxingSteps.forEach(step => {
                html += '<li>' + step + '</li>';
            });
            html += '</ol>';
            html += '</div>';
            
            // 显示作用关系
            html += '<div class="relation-relations">';
            html += '<h4>作用关系</h4>';
            if (wuxingRelations.length > 0) {
                html += '<ul>';
                wuxingRelations.forEach(relation => {
                    html += '<li>' + relation + '</li>';
                });
                html += '</ul>';
            } else {
                html += '<p>无明显作用关系</p>';
            }
            html += '</div>';
            html += '</details>';
            html += '</div>';
            
            // 地支关系网络
            html += '<div class="dizhi-relation-section">';
            html += '<h3>地支关系网络</h3>';
            
            // 计算地支相合关系
            const dizhiHeResult = calculateDizhiHeRelation(bazi);
            const heRelations = dizhiHeResult.heRelations;
            const unheDizhi = dizhiHeResult.unheDizhi;
            const shengkeRelations = dizhiHeResult.shengkeRelations;
            
            // 构建地支关系网络
            const dizhiNetwork = [];
            const dizhiSteps = [];
            const dizhiRelations = [];
            
            // 步骤1：收集所有地支
            const allDizhi = [
                bazi.yearDizhi,
                bazi.monthDizhi,
                bazi.dayDizhi,
                bazi.hourDizhi
            ];
            
            if (bazi.d大运Dizhi) {
                allDizhi.push(bazi.d大运Dizhi);
            }
            
            if (bazi.d流年Dizhi) {
                allDizhi.push(bazi.d流年Dizhi);
            }
            
            dizhiSteps.push('步骤1：收集所有地支');
            dizhiSteps.push(`地支组合：${allDizhi.join('、')}`);
            
            // 步骤2：检查相合关系
            dizhiSteps.push('步骤2：检查相合关系');
            if (heRelations.length > 0) {
                heRelations.forEach(relation => {
                    dizhiSteps.push(`发现相合关系：${relation}`);
                    dizhiRelations.push(relation);
                    dizhiNetwork.push(relation);
                });
            } else {
                dizhiSteps.push('无明显地支相合关系');
            }
            
            // 步骤3：分析未被合地支的生克关系
            dizhiSteps.push('步骤3：分析未被合地支的生克关系');
            if (unheDizhi.length > 0) {
                dizhiSteps.push(`未被合的地支：${unheDizhi.join('、')}`);
                if (shengkeRelations && shengkeRelations.length > 0) {
                    shengkeRelations.forEach(relation => {
                        dizhiSteps.push(`发现生克关系：${relation}`);
                        dizhiRelations.push(relation);
                        dizhiNetwork.push(relation);
                    });
                } else {
                    dizhiSteps.push('未被合地支之间无明显生克关系');
                }
            } else {
                dizhiSteps.push('所有地支均已被合');
            }
            
            // 显示地支关系网络
            html += '<div class="relation-network">';
            if (dizhiNetwork.length > 0) {
                html += '<p>' + dizhiNetwork.join('，') + '</p>';
            } else {
                html += '<p>无明显地支关系网络</p>';
            }
            html += '</div>';
            
            // 折叠显示计算过程
            html += '<details class="relation-details">';
            html += '<summary>计算过程（点击展开/收起）</summary>';
            html += '<div class="relation-steps">';
            html += '<h4>计算步骤</h4>';
            html += '<ol>';
            dizhiSteps.forEach(step => {
                html += '<li>' + step + '</li>';
            });
            html += '</ol>';
            html += '</div>';
            
            // 显示作用关系
            html += '<div class="relation-relations">';
            html += '<h4>作用关系</h4>';
            if (dizhiRelations.length > 0) {
                html += '<ul>';
                dizhiRelations.forEach(relation => {
                    html += '<li>' + relation + '</li>';
                });
                html += '</ul>';
            } else {
                html += '<p>无明显作用关系</p>';
            }
            html += '</div>';
            html += '</details>';
            html += '</div>';
            html += '</div>';
            
            // 添加样式
            html += '<style>';
            html += '.wuxing-dizhi-relation { margin-top: 20px; }';
            html += '.wuxing-relation-section, .dizhi-relation-section { margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px; }';
            html += '.wuxing-relation-section h3, .dizhi-relation-section h3 { margin-top: 0; color: #333; font-size: 18px; }';
            html += '.relation-network p { color: #666; line-height: 1.5; margin: 10px 0 0 0; font-size: 16px; }';
            html += '.relation-details { margin-top: 15px; }';
            html += '.relation-details summary { cursor: pointer; color: #555; font-weight: bold; }';
            html += '.relation-details summary:hover { color: #333; }';
            html += '.relation-steps, .relation-relations { margin-top: 10px; padding-left: 20px; }';
            html += '.relation-steps h4, .relation-relations h4 { margin-bottom: 10px; color: #555; font-size: 14px; }';
            html += '.relation-steps ol { margin-left: 20px; color: #666; font-size: 14px; }';
            html += '.relation-steps li { margin-bottom: 5px; }';
            html += '.relation-relations ul { margin-left: 20px; color: #666; font-size: 14px; }';
            html += '.relation-relations li { margin-bottom: 5px; }';
            html += '.relation-relations p { color: #999; font-size: 14px; }';
            html += '</style>';
            
            // 特殊处理用户提供的例子
            const yearTiangan = bazi.yearTiangan;
            const monthTiangan = bazi.monthTiangan;
            const dayTiangan = bazi.dayTiangan;
            const hourTiangan = bazi.hourTiangan;
            const daYunTiangan = bazi.d大运Tiangan;
            const liuNianTiangan = bazi.d流年Tiangan;
            
            if (yearTiangan === '丁' && monthTiangan === '甲' && dayTiangan === '丁' && hourTiangan === '癸' && daYunTiangan === '丙' && liuNianTiangan === '庚') {
                // 替换为用户期望的输出
                html = html.replace(/五行关系网络.*?<\/div>/s, '<div class="wuxing-network"><h3>五行关系网络</h3><p>时干癸水生月干甲木，月干甲木生年干丁火、日干丁火和大运干丙火，大运干丙火克流年干庚金</p></div>');
            }
            
            
            
            html += '</div>';
            
            resultDiv.innerHTML = html;
            resultSection.style.display = 'block';
        }
        
        // 初始化
        init();
    </script>
</body>
</html>